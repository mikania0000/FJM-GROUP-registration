<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>çµ„éšŠå ±åç³»çµ±</title>
<style>
  :root{
    --wrap: 1200px;
    --radius: 12px;
    --page: #f0f2f5;
    --text: #1f2937;
    --card: #fff;
    --shadow: 0 4px 6px -1px rgba(0,0,0,.1), 0 2px 4px -1px rgba(0,0,0,.06);
    --blue: #2563eb; --green:#16a34a; --red:#dc2626; --yellow:#ca8a04; --pink:#ec4899;
  }

  html,body{height:100%}
  body{
    margin:0; background:var(--page); color:var(--text);
    font-family: system-ui, -apple-system, "Noto Sans TC", sans-serif;
  }
  .wrap{ max-width:var(--wrap); margin:20px auto; padding:0 16px; }

  .header-title{
    font-size: 36px; font-weight:900; text-align:center; margin-bottom: 20px;
    background:#fff9c4; padding:15px; border-radius:var(--radius); box-shadow:var(--shadow);
  }

  /* æç¤ºè¨Šæ¯ */
  .toast{
    position: fixed; left:50%; top:20px; transform:translateX(-50%);
    color:#fff; padding:12px 24px; border-radius:8px; box-shadow:var(--shadow);
    z-index:1000; display:none; font-weight: bold; font-size: 18px;
  }
  .toast.show{ display:block; }
  .toast.success{ background:var(--green); }
  .toast.error{ background:var(--red); }
  .toast.info{ background:var(--blue); }

  /* è¼‰å…¥ä¸­ */
  #loader {
    position: fixed; top:0; left:0; width:100%; height:100%;
    background: rgba(255,255,255,0.8); z-index: 999;
    display: flex; justify-content: center; align-items: center;
    font-size: 24px; font-weight: bold; color: var(--blue);
  }

  /* ç‰ˆé¢é…ç½®ï¼šå·¦å³åˆ†æ¬„ */
  .layout { display: flex; gap: 20px; flex-wrap: wrap; }
  .col-left { flex: 3; min-width: 300px; }
  .col-right { flex: 2; min-width: 300px; }

  .card {
    background: var(--card); border-radius: var(--radius);
    padding: 20px; box-shadow: var(--shadow); margin-bottom: 20px;
  }

  /* æ§åˆ¶åˆ— */
  .controls { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; margin-bottom: 15px;}
  select { padding: 10px; border-radius: 8px; border: 1px solid #ccc; font-size: 16px; min-width: 150px;}
  .btn { 
    padding: 10px 15px; border: none; border-radius: 8px; color: #fff; 
    font-size: 16px; cursor: pointer; font-weight: bold; transition: opacity 0.2s;
  }
  .btn:hover { opacity: 0.8; }
  .btn.blue { background: var(--blue); }
  .btn.green { background: var(--green); }
  .btn.red { background: var(--red); }
  .btn.yellow { background: var(--yellow); color: #fff; }
  .btn.pink { background: var(--pink); }

  /* å­¸ç”Ÿåå–®è¡¨æ ¼ (å·¦å´) */
  table { width: 100%; border-collapse: collapse; margin-top: 10px; }
  th, td { padding: 10px; text-align: center; border-bottom: 1px solid #eee; }
  th { background: #f8fafc; font-weight: bold; color: #475569; }
  tr:hover { background: #f1f5f9; }
  
  .student-row { cursor: pointer; }
  .student-row.selected { background: #e0f2fe; }
  .student-row.disabled { opacity: 0.5; cursor: not-allowed; background: #f3f4f6;}

  /* å¾…æäº¤æ¸…å–® (å³å´) */
  .group-info { background: #e0e7ff; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-weight:bold;}
  .selected-list { min-height: 200px; border: 2px dashed #cbd5e1; border-radius: 8px; padding: 10px; }
  
  .selected-item {
    display: flex; justify-content: space-between; align-items: center;
    background: #fff; border: 1px solid #e2e8f0; padding: 10px; margin-bottom: 8px;
    border-radius: 6px; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
  }
  .tag { padding: 4px 8px; border-radius: 4px; font-size: 14px; font-weight: bold; }
  .tag.main { background: #dcfce7; color: #166534; } /* æ­£å–ç¶ è‰² */
  .tag.wait { background: #fef08a; color: #854d0e; } /* å‚™å–é»ƒè‰² */
  
  .remove-btn { 
    background: #fee2e2; color: #b91c1c; border: none; border-radius: 4px; 
    padding: 4px 8px; cursor: pointer; font-size: 12px; font-weight: bold;
  }

  /* å¯†ç¢¼è¦–çª— */
  .modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000;
  }
  .modal { background: #fff; padding: 24px; border-radius: 12px; width: 300px; text-align: center; }
  .modal input { width: 80%; padding: 10px; margin: 15px 0; border: 1px solid #ccc; border-radius: 6px; text-align:center; font-size: 18px;}

</style>
</head>
<body>

<div id="loader">è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™...</div>
<div id="toast" class="toast"></div>

<div class="wrap">
  <div class="header-title" id="pageTitle">çµ„éšŠå ±åç³»çµ±</div>

  <div class="card" id="noticeCard" style="background:#e8f8e8; border:1px solid #cde8cd; display:none;">
    <h3>ğŸ“Œ å ±åèªªæ˜ï¼š</h3>
    <div id="noticeContent"></div>
  </div>

  <div class="layout">
    <!-- å·¦å´ï¼šæŒ‘é¸å­¸ç”Ÿ -->
    <div class="col-left">
      <div class="card">
        <div class="controls">
          <select id="classSelect"><option value="">-- è«‹é¸æ“‡ç­ç´š --</option></select>
          <button class="btn blue" onclick="queryStudents()">æŸ¥è©¢åå–®</button>
          <button class="btn yellow" onclick="fetchSignedList()">æŸ¥çœ‹å·²å ±ååå–®</button>
          <button class="btn pink" onclick="showAdminModal()">é€²éšè¨­å®š</button>
        </div>
        
        <h3 style="margin-top:20px; border-bottom:2px solid #2563eb; display:inline-block;">ç­ç´šå­¸ç”Ÿåˆ—è¡¨</h3>
        <p style="color:#64748b; font-size:14px;">(é»æ“Šè¡¨æ ¼åˆ—å³å¯å°‡å­¸ç”ŸåŠ å…¥å³å´éšŠä¼ã€‚åˆ‡æ›ç­ç´šä¸æœƒæ¸…ç©ºå³å´åå–®ï¼Œå¯è·¨ç­çµ„éšŠ)</p>
        <div style="overflow-x:auto;">
          <table id="studentTable">
            <thead>
              <tr><th>ç­ç´š</th><th>åº§è™Ÿ</th><th>å§“å</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th></tr>
            </thead>
            <tbody id="studentTbody">
              <tr><td colspan="5">è«‹å…ˆé¸æ“‡ç­ç´šä¸¦é»æ“ŠæŸ¥è©¢</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- å³å´ï¼šå¾…æäº¤çµ„éšŠåå–® -->
    <div class="col-right">
      <div class="card" style="border: 2px solid #2563eb;">
        <h3 style="margin-top:0; color:#1e3a8a;">ğŸ“ ç›®å‰çµ„éšŠç‹€æ…‹ (å¾…å„²å­˜)</h3>
        
        <div class="group-info" id="groupRuleInfo">
          è¨­å®šï¼šæ¯çµ„æ­£å– 3 äººï¼Œå¯å‚™å– 1 çµ„ (3 äºº)
        </div>

        <div class="selected-list" id="selectedListContainer">
           <!-- é¸å–çš„å­¸ç”Ÿæœƒé¡¯ç¤ºåœ¨é€™è£¡ -->
           <div style="text-align:center; color:#94a3b8; margin-top:50px;">å°šç„¡é¸å–å­¸ç”Ÿ<br>è«‹å¾å·¦å´é»æ“ŠåŠ å…¥</div>
        </div>

        <div style="margin-top: 20px; display: flex; gap: 10px;">
          <button class="btn green" style="flex:2; font-size: 18px;" onclick="submitGroup()">é€å‡ºå ±å</button>
          <button class="btn red" style="flex:1;" onclick="clearSelected()">æ¸…ç©ºé‡é¸</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ç®¡ç†å“¡å¯†ç¢¼è¦–çª— -->
<div class="modal-overlay" id="adminModal">
  <div class="modal">
    <h3>ç®¡ç†å“¡é©—è­‰</h3>
    <input type="password" id="adminPwd" placeholder="è«‹è¼¸å…¥å¯†ç¢¼ (é è¨­000000)" maxlength="6">
    <div>
      <button class="btn red" onclick="document.getElementById('adminModal').style.display='none'">å–æ¶ˆ</button>
      <button class="btn green" onclick="verifyAdmin()">ç¢ºå®š</button>
    </div>
  </div>
</div>

<script>
  // ==========================================
  // âš ï¸ éƒ¨ç½²è¨­å®šå€ï¼šè«‹æ›¿æ›ç‚ºæ‚¨çš„ GAS ç¶²é æ‡‰ç”¨ç¨‹å¼ç¶²å€
  // ==========================================
  const GAS_API_URL = "https://script.google.com/macros/s/AKfycbyeE8XjA9r9n2fG1l6MhYf4N_2hR1c8pY-hV_5wD1i8D7fR_8jR5P-8H9Zz-4x_7H/exec"; 
  
  // ç³»çµ±å…¨åŸŸè®Šæ•¸
  let sysConfig = { groupSize: 3, waitlistCount: 1 };
  let currentClassStudents = []; // ç›®å‰å·¦å´é¡¯ç¤ºçš„å­¸ç”Ÿè³‡æ–™
  let selectedTeam = []; // å³å´å¾…æäº¤çš„çµ„éšŠåå–®

  // ================== UI è¼”åŠ©å‡½å¼ ==================
  function showLoader(show) { document.getElementById('loader').style.display = show ? 'flex' : 'none'; }
  function showToast(msg, type='success') {
    const el = document.getElementById('toast');
    el.textContent = msg; el.className = 'toast ' + type + ' show';
    setTimeout(() => el.classList.remove('show'), 3000);
  }

  // ================== åˆå§‹åŒ–è¼‰å…¥ ==================
  window.onload = () => {
    showLoader(true);
    // ä½¿ç”¨ GET è«‹æ±‚å–å¾—åˆå§‹è³‡æ–™
    fetch(`${GAS_API_URL}?action=getInitData`)
      .then(res => res.json())
      .then(data => {
        if(data.error) throw new Error(data.error);
        
        document.getElementById('pageTitle').textContent = data.title;
        document.title = data.title;
        
        sysConfig.groupSize = data.groupSize || 3;
        sysConfig.waitlistCount = data.waitlistCount || 1;
        updateGroupRuleText();

        // è™•ç†æ³¨æ„äº‹é …
        if(data.notices && data.notices.length > 0) {
          document.getElementById('noticeCard').style.display = 'block';
          document.getElementById('noticeContent').innerHTML = data.notices.map(n => `<p>${n}</p>`).join('');
        }

        // è™•ç†ç­ç´šä¸‹æ‹‰é¸å–®
        const select = document.getElementById('classSelect');
        data.classes.forEach(c => {
          let opt = document.createElement('option');
          opt.value = c; opt.text = c;
          select.appendChild(opt);
        });
        
        showLoader(false);
      })
      .catch(err => {
        showLoader(false);
        showToast("åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹ç¢ºèª GAS ç¶²å€æ˜¯å¦æ­£ç¢º: " + err.message, "error");
      });
  };

  function updateGroupRuleText() {
    const maxTotal = sysConfig.groupSize + (sysConfig.groupSize * sysConfig.waitlistCount);
    document.getElementById('groupRuleInfo').textContent = 
      `è¨­å®šï¼šæ¯çµ„æ­£å– ${sysConfig.groupSize} äººï¼Œå‚™å– ${sysConfig.waitlistCount} çµ„ (å…±å¯é¸ ${maxTotal} äºº)`;
  }

  // ================== æŸ¥è©¢ç­ç´šå­¸ç”Ÿ ==================
  function queryStudents() {
    const cls = document.getElementById('classSelect').value;
    if(!cls) return showToast("è«‹å…ˆé¸æ“‡ç­ç´š", "error");

    showLoader(true);
    fetch(`${GAS_API_URL}?action=queryByClass&className=${encodeURIComponent(cls)}`)
      .then(res => res.json())
      .then(data => {
        showLoader(false);
        if(data.error) throw new Error(data.error);
        
        currentClassStudents = data.rows;
        renderStudentTable();
      })
      .catch(err => {
        showLoader(false); showToast("æŸ¥è©¢å¤±æ•—: " + err.message, "error");
      });
  }

  function renderStudentTable() {
    const tbody = document.getElementById('studentTbody');
    tbody.innerHTML = '';
    
    if(currentClassStudents.length === 0) {
      tbody.innerHTML = `<tr><td colspan="5">æŸ¥ç„¡è³‡æ–™</td></tr>`;
      return;
    }

    currentClassStudents.forEach(stu => {
      const tr = document.createElement('tr');
      tr.className = 'student-row';
      
      // åˆ¤æ–·æ˜¯å¦å·²è¢«é¸å…¥å³å´
      const isSelected = selectedTeam.some(s => s.rowIndex === stu.rowIndex);
      // åˆ¤æ–·æ˜¯å¦å·²ç¶“åœ¨è³‡æ–™åº«å ±åé
      const isAlreadySigned = stu.E == 1 || stu.E == '1';

      if (isSelected) tr.classList.add('selected');
      if (isAlreadySigned && !isSelected) {
        tr.classList.add('disabled');
        tr.title = "å·²å ±å (" + (stu.F || 'ç„¡çµ„åˆ¥è³‡è¨Š') + ")";
      }

      tr.innerHTML = `
        <td>${stu.A}</td><td>${stu.B}</td><td>${stu.C}</td>
        <td>
          ${isSelected ? '<span style="color:var(--blue);font-weight:bold;">å·²é¸å–</span>' : 
            (isAlreadySigned ? `<span style="color:var(--red);">${stu.F || 'å·²å ±å'}</span>` : '<span style="color:#94a3b8;">æœªå ±å</span>')}
        </td>
        <td>
           ${(!isAlreadySigned || isSelected) ? 
             `<button class="btn ${isSelected ? 'red' : 'green'}" style="padding:4px 8px;font-size:14px;" 
               onclick="toggleSelect(${stu.rowIndex}, event)">
               ${isSelected ? 'ç§»é™¤' : 'åŠ å…¥'}
             </button>` : 'ç„¡æ³•æ›´å‹•'
           }
        </td>
      `;
      // é»æ“Šæ•´åˆ—ä¹Ÿå¯ä»¥è§¸ç™¼
      tr.onclick = (e) => { if(!isAlreadySigned || isSelected) toggleSelect(stu.rowIndex, e); };
      tbody.appendChild(tr);
    });
  }

  // ================== è™•ç†é¸å–é‚è¼¯ ==================
  function toggleSelect(rowIndex, event) {
    if(event) event.stopPropagation(); // é¿å…é»æ“ŠæŒ‰éˆ•åˆè§¸ç™¼åˆ—é»æ“Š
    
    const stuIdx = currentClassStudents.findIndex(s => s.rowIndex === rowIndex);
    const stu = currentClassStudents[stuIdx];
    
    // æª¢æŸ¥æ˜¯å¦å·²åœ¨åå–®ä¸­ï¼Œè‹¥æ˜¯å‰‡ç§»é™¤
    const existingIdx = selectedTeam.findIndex(s => s.rowIndex === rowIndex);
    if (existingIdx > -1) {
      selectedTeam.splice(existingIdx, 1);
      refreshTeamLabels();
      renderStudentTable();
      renderSelectedList();
      return;
    }

    // è¨ˆç®—äººæ•¸ä¸Šé™
    const maxTotal = sysConfig.groupSize + (sysConfig.groupSize * sysConfig.waitlistCount);
    if (selectedTeam.length >= maxTotal) {
      return showToast(`å·²é”é¸å–ä¸Šé™ (${maxTotal}äºº)`, "error");
    }

    // åŠ å…¥åå–®
    selectedTeam.push({...stu});
    refreshTeamLabels();
    renderStudentTable();
    renderSelectedList();
  }

  // é‡æ–°è¨ˆç®—åå–®ä¸­æ¯å€‹äººçš„ Label (æ­£å– / å‚™å–X)
  function refreshTeamLabels() {
    // å‡è¨­ä»£è¡¨éšŠä¼çš„ç­ç´šæ˜¯ç”±ç¬¬ä¸€å€‹é¸å–çš„äººæ±ºå®š
    const mainClass = selectedTeam.length > 0 ? selectedTeam[0].A : '';
    
    selectedTeam.forEach((s, idx) => {
      if (idx < sysConfig.groupSize) {
        s.targetLabel = `${mainClass}-æ­£å–`;
        s.tagClass = 'main';
      } else {
        // è¨ˆç®—æ˜¯å‚™å–å¹¾ (1-based)
        const waitlistNum = Math.floor((idx - sysConfig.groupSize) / sysConfig.groupSize) + 1;
        s.targetLabel = `${mainClass}-å‚™å–${waitlistNum}`;
        s.tagClass = 'wait';
      }
    });
  }

  function renderSelectedList() {
    const container = document.getElementById('selectedListContainer');
    if (selectedTeam.length === 0) {
      container.innerHTML = `<div style="text-align:center; color:#94a3b8; margin-top:50px;">å°šç„¡é¸å–å­¸ç”Ÿ<br>è«‹å¾å·¦å´é»æ“ŠåŠ å…¥</div>`;
      return;
    }

    container.innerHTML = selectedTeam.map(s => `
      <div class="selected-item">
        <div>
          <span style="display:inline-block; width:40px; color:#64748b;">${s.A}</span>
          <span style="display:inline-block; width:30px; color:#64748b;">${s.B}</span>
          <strong style="font-size:16px;">${s.C}</strong>
        </div>
        <div>
          <span class="tag ${s.tagClass}">${s.targetLabel}</span>
          <button class="remove-btn" onclick="toggleSelect(${s.rowIndex}, event)">âœ•</button>
        </div>
      </div>
    `).join('');
  }

  function clearSelected() {
    if(confirm("ç¢ºå®šè¦æ¸…ç©ºç›®å‰é¸å–çš„åå–®å—ï¼Ÿ")) {
      selectedTeam = [];
      renderStudentTable();
      renderSelectedList();
    }
  }

  // ================== é€å‡ºå„²å­˜ ==================
  function submitGroup() {
    if (selectedTeam.length === 0) return showToast("è«‹å…ˆé¸å–å­¸ç”Ÿï¼", "error");
    
    // æª¢æŸ¥æ˜¯å¦ç¬¦åˆäººæ•¸è¦å®š (å¯é¸ï¼šå¼·åˆ¶è¦æ±‚é¸æ»¿æ­£å–æ‰èƒ½é€å‡º)
    if (selectedTeam.length < sysConfig.groupSize) {
      if(!confirm(`ç›®å‰åƒ…é¸å– ${selectedTeam.length} äººï¼Œæœªé”æ­£å–äººæ•¸(${sysConfig.groupSize}äºº)ï¼Œç¢ºå®šè¦é€å‡ºå—ï¼Ÿ`)) return;
    }

    // æ•´ç†è¦å‚³çµ¦å¾Œç«¯çš„è³‡æ–™æ ¼å¼
    const payload = selectedTeam.map(s => ({
      rowIndex: s.rowIndex,
      E: 1, // åƒåŠ ç‹€æ…‹è¨­ç‚º 1
      F: s.targetLabel // å¯«å…¥çµ„åˆ¥ (ä¾‹å¦‚: 701-æ­£å–)
    }));

    showLoader(true);
    fetch(GAS_API_URL, {
      method: 'POST',
      body: JSON.stringify({ action: 'saveGroupSignup', payload: payload })
    })
    .then(res => res.json())
    .then(data => {
      showLoader(false);
      if(data.error) throw new Error(data.error);
      
      showToast("å ±åå„²å­˜æˆåŠŸï¼");
      selectedTeam = []; // æ¸…ç©ºå¾…æäº¤
      renderSelectedList();
      
      // é‡æ–°æ•´ç†å·¦å´è¡¨æ ¼ä»¥é¡¯ç¤ºæœ€æ–°ç‹€æ…‹
      queryStudents(); 
    })
    .catch(err => {
      showLoader(false); showToast("å„²å­˜å¤±æ•—: " + err.message, "error");
    });
  }

  // ================== æª¢è¦–å·²å ±åæ¸…å–® (ç°¡æ˜“ç‰ˆ) ==================
  function fetchSignedList() {
    showLoader(true);
    fetch(`${GAS_API_URL}?action=getSignedList`)
      .then(res => res.json())
      .then(data => {
        showLoader(false);
        if(data.error) throw new Error(data.error);
        if(!data.rows || data.rows.length === 0) return showToast("ç›®å‰ç„¡äººå ±å", "info");

        // ç›´æ¥æ›¿æ›å·¦å´è¡¨æ ¼å…§å®¹é¡¯ç¤º
        const thead = `<tr>${data.headers.map(h => `<th>${h}</th>`).join('')}</tr>`;
        const tbody = data.rows.map(r => `<tr>${r.map(c => `<td>${c}</td>`).join('')}</tr>`).join('');
        
        document.getElementById('studentTable').innerHTML = `<thead>${thead}</thead><tbody>${tbody}</tbody>`;
        document.getElementById('studentTable').parentElement.previousElementSibling.textContent = "å…¨æ ¡å·²å ±ååå–®";
      })
      .catch(err => {
        showLoader(false); showToast("å–å¾—åå–®å¤±æ•—: " + err.message, "error");
      });
  }

  // ================== ç®¡ç†å“¡é€²éšè¨­å®š ==================
  function showAdminModal() {
    document.getElementById('adminPwd').value = '';
    document.getElementById('adminModal').style.display = 'flex';
  }

  function verifyAdmin() {
    const pwd = document.getElementById('adminPwd').value;
    if(pwd !== '000000') {
      showToast("å¯†ç¢¼éŒ¯èª¤", "error");
      return;
    }
    document.getElementById('adminModal').style.display = 'none';
    
    if(confirm("ç®¡ç†å“¡æ‚¨å¥½ï¼\næ˜¯å¦è¦æ¸…é™¤ã€Œæ‰€æœ‰å­¸ç”Ÿã€çš„å ±åç´€éŒ„(æ¢å¾©é è¨­å€¼)ï¼Ÿ\nè­¦å‘Šï¼šæ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼")) {
      showLoader(true);
      fetch(GAS_API_URL, {
        method: 'POST',
        body: JSON.stringify({ action: 'resetDefaults' })
      })
      .then(res => res.json())
      .then(data => {
        showLoader(false);
        if(data.error) throw new Error(data.error);
        showToast("å·²æ¢å¾©é è¨­å€¼ï¼æ‰€æœ‰åå–®å·²æ¸…ç©ºã€‚");
        currentClassStudents = [];
        document.getElementById('studentTbody').innerHTML = `<tr><td colspan="5">è«‹é‡æ–°æŸ¥è©¢ç­ç´š</td></tr>`;
      })
      .catch(err => {
        showLoader(false); showToast("é‡è¨­å¤±æ•—: " + err.message, "error");
      });
    }
  }

</script>
</body>
</html>