<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>çµ„éšŠå ±åç³»çµ±</title>
<style>
  :root {
    /* æ›´é®®è±”ã€ç¾ä»£çš„ APP é…è‰² */
    --primary: #2563eb;       /* ä¸»è‰²ï¼šé®®è±”è— */
    --primary-light: #dbeafe; 
    --success: #059669;       /* æˆåŠŸ/æ­£å–ï¼šç¿ ç¶ è‰² */
    --danger: #e11d48;        /* å±éšª/ç§»é™¤ï¼šç«ç‘°ç´… */
    --warning: #d97706;       /* å‚™å–ï¼šç¥ç€æ©˜ */
    --info: #0ea5e9;          /* è³‡è¨Šï¼šå¤©è—è‰² */
    --bg-page: #f1f5f9;       /* é é¢èƒŒæ™¯ï¼šæ·ºç°è— */
    --card-bg: #ffffff;
    --text-main: #0f172a;
    --text-muted: #64748b;
    --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
    --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
    --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
  }

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  
  html, body { height: 100%; margin: 0; }
  body {
    background: var(--bg-page); color: var(--text-main);
    font-family: system-ui, -apple-system, "Noto Sans TC", sans-serif;
    padding-bottom: 80px; /* é ç•™çµ¦æ‰‹æ©Ÿç‰ˆç½®åº•åˆ—çš„ç©ºé–“ */
  }
  
  .wrap { max-width: 1200px; margin: 20px auto; padding: 0 16px; }

  /* é ‚éƒ¨æ¨™é¡Œ - æ¼¸å±¤é®®è±”è‰²å½© */
  .header-title {
    font-size: 32px; font-weight: 900; text-align: center; margin-bottom: 20px;
    background: linear-gradient(135deg, #1e3a8a, #3b82f6); color: #fff;
    padding: 20px; border-radius: 16px; box-shadow: var(--shadow-md);
    letter-spacing: 2px;
  }

  /* æç¤ºè¨Šæ¯ */
  .toast {
    position: fixed; left: 50%; top: 20px; transform: translateX(-50%);
    color: #fff; padding: 14px 28px; border-radius: 999px; box-shadow: var(--shadow-lg);
    z-index: 1100; display: none; font-weight: 800; font-size: 16px; white-space: nowrap;
  }
  .toast.show { display: block; animation: popDown 0.3s ease forwards; }
  @keyframes popDown { from { top: -20px; opacity: 0; } to { top: 20px; opacity: 1; } }
  .toast.success { background: var(--success); }
  .toast.error { background: var(--danger); }
  .toast.info { background: var(--info); }

  /* è¼‰å…¥ä¸­ */
  #loader {
    position: fixed; inset: 0; background: rgba(255,255,255,0.85); z-index: 1000;
    display: flex; justify-content: center; align-items: center; flex-direction: column;
  }
  .spinner {
    width: 50px; height: 50px; border: 5px solid var(--primary-light);
    border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* ç‰ˆé¢é…ç½® */
  .layout { display: flex; gap: 24px; flex-wrap: wrap; }
  .col-left { flex: 3; min-width: 320px; }
  .col-right { flex: 2; min-width: 320px; }

  .card {
    background: var(--card-bg); border-radius: 16px;
    padding: 20px; box-shadow: var(--shadow-md); margin-bottom: 20px;
  }

  /* æŒ‰éˆ•èˆ‡æ§åˆ¶åˆ— */
  .controls { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; margin-bottom: 20px; }
  select { 
    padding: 12px 16px; border-radius: 12px; border: 2px solid #cbd5e1; 
    font-size: 16px; min-width: 160px; font-weight: bold; outline: none;
  }
  select:focus { border-color: var(--primary); }
  
  .btn { 
    padding: 12px 20px; border: none; border-radius: 999px; color: #fff; 
    font-size: 16px; cursor: pointer; font-weight: 800; transition: all 0.2s;
    display: inline-flex; align-items: center; justify-content: center;
  }
  .btn:active { transform: scale(0.95); }
  .btn.blue { background: var(--primary); }
  .btn.green { background: var(--success); }
  .btn.red { background: var(--danger); }
  .btn.yellow { background: var(--warning); color: #fff; }
  .btn.pink { background: #db2777; }
  .btn.outline { background: transparent; border: 2px solid var(--danger); color: var(--danger); }

  /* ===== APP é¢¨æ ¼çš„å­¸ç”Ÿåå–® ===== */
  .stu-list { display: flex; flex-direction: column; gap: 12px; margin-top: 10px; }
  
  .stu-card {
    display: flex; align-items: center; justify-content: space-between;
    padding: 16px; background: var(--card-bg); border-radius: 16px;
    box-shadow: var(--shadow-sm); border: 2px solid #e2e8f0;
    cursor: pointer; transition: 0.2s;
  }
  .stu-card:active { background: #f8fafc; transform: scale(0.99); }
  .stu-card.selected { border-color: var(--primary); background: var(--primary-light); }
  .stu-card.signed { background: #f8fafc; border-color: #cbd5e1; cursor: default; }
  .stu-card.disabled { opacity: 0.6; cursor: not-allowed; background: #f1f5f9; border-color: transparent;}
  
  .stu-info { display: flex; flex-direction: column; gap: 4px; }
  .stu-meta { font-size: 14px; color: var(--text-muted); font-weight: bold; }
  .stu-name { font-size: 20px; font-weight: 900; color: var(--text-main); }
  
  .stu-status-area { display: flex; align-items: center; gap: 12px; }
  .status-text { font-size: 15px; font-weight: 800; }
  
  .action-btn {
    padding: 8px 16px; border-radius: 999px; border: none; color: white;
    font-size: 14px; font-weight: bold; cursor: pointer;
  }
  .action-btn.add { background: var(--primary); }
  .action-btn.remove { background: var(--danger); }
  .action-btn.outline { background: transparent; border: 2px solid var(--text-muted); color: var(--text-muted); }

  /* å¾…æäº¤æ¸…å–® (å³å´) */
  .group-info { 
    background: #e0e7ff; color: #3730a3; padding: 12px; border-radius: 12px; 
    margin-bottom: 15px; font-weight: 900; font-size: 16px; border: 1px dashed #818cf8;
  }
  .selected-list { min-height: 150px; display: flex; flex-direction: column; gap: 12px; }
  
  .selected-item {
    background: var(--card-bg); border-left: 6px solid var(--primary);
    border-radius: 12px; padding: 16px;
    display: flex; justify-content: space-between; align-items: center;
    box-shadow: var(--shadow-sm); border-top: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0; border-bottom: 1px solid #e2e8f0;
  }
  
  .tag { border-radius: 8px; font-size: 14px; font-weight: 900; padding: 6px 12px; color: white; letter-spacing: 1px;}
  .tag.main { background: var(--success); }
  .tag.wait { background: var(--warning); }
  .tag.danger { background: var(--danger); }
  
  .remove-btn-small { 
    background: #f1f5f9; color: var(--text-muted); border: 1px solid #cbd5e1; border-radius: 8px; 
    padding: 6px 12px; cursor: pointer; font-size: 14px; font-weight: 900;
  }
  .remove-btn-small:hover { background: #fee2e2; color: var(--danger); border-color: var(--danger); }

  /* å·²å ±ååå–®è¡¨æ ¼å°ˆç”¨ (é®®è±”æ¨£å¼) */
  .vibrant-table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 500px; }
  .vibrant-table th { background: var(--primary); color: white; padding: 16px; text-align: left; font-size: 16px;}
  .vibrant-table td { padding: 16px; background: white; border-bottom: 1px solid #e2e8f0; font-size: 16px; font-weight: bold; vertical-align: middle;}
  .vibrant-table tr:hover td { background: #f8fafc; }
  .vibrant-table th:first-child { border-top-left-radius: 12px; }
  .vibrant-table th:last-child { border-top-right-radius: 12px; }

  /* ===== æ‰‹æ©Ÿç‰ˆå°ˆå±¬ï¼šç½®åº•æ“ä½œåˆ— ===== */
  .mobile-bottom-bar {
    display: none; position: fixed; bottom: 0; left: 0; width: 100%;
    background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
    box-shadow: 0 -4px 15px rgba(0,0,0,0.1); padding: 12px 20px; 
    align-items: center; justify-content: space-between; z-index: 900;
    border-top: 1px solid #e2e8f0;
  }
  
  /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
  @media (max-width: 768px) {
    .col-main { order: 2; } /* æ‰‹æ©Ÿç‰ˆï¼šå­¸ç”Ÿåå–®åœ¨ä¸‹æ–¹ */
    .col-side { order: 1; } /* æ‰‹æ©Ÿç‰ˆï¼šå·²é¸éšŠä¼åœ¨ä¸Šæ–¹ */
    .mobile-bottom-bar { display: flex; } /* é¡¯ç¤ºæ‰‹æ©Ÿç½®åº•åˆ— */
    .desktop-submit-area { display: none; } /* éš±è—æ¡Œæ©Ÿç‰ˆæŒ‰éˆ•å€ */
    body { padding-bottom: 90px; }
    
    .header-title { font-size: 24px; padding: 15px; }
    .stu-card { padding: 12px; }
    .stu-name { font-size: 18px; }
    .controls { flex-direction: column; align-items: stretch; }
  }

  /* å¯†ç¢¼è¦–çª— & æ›¿æ›è¦–çª— */
  .modal-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);
    display: none; justify-content: center; align-items: center; z-index: 1200;
  }
  .modal { background: #fff; padding: 30px; border-radius: 20px; width: 340px; text-align: center; box-shadow: var(--shadow-lg);}
  .modal input, .modal select { 
    width: 100%; padding: 14px; margin: 20px 0; border: 2px solid #cbd5e1; 
    border-radius: 12px; font-size: 18px; font-weight: bold;
  }
  .modal input:focus, .modal select:focus { border-color: var(--primary); outline: none; }
</style>
</head>
<body>

<div id="loader">
  <div class="spinner"></div>
  <div style="margin-top: 15px; font-weight: bold; color: var(--primary); font-size: 18px;">ç³»çµ±è¼‰å…¥ä¸­...</div>
</div>
<div id="toast" class="toast"></div>

<div class="wrap layout">
  
  <!-- å·¦å´ï¼šæŒ‘é¸å­¸ç”Ÿ -->
  <div class="col-left col-main">
    <div class="header-title" id="pageTitle">çµ„éšŠå ±åç³»çµ±</div>

    <div class="card" id="noticeCard" style="background:#ecfdf5; border:2px solid #a7f3d0; display:none;">
      <h3 style="margin-top:0; color:var(--success);">ğŸ“Œ å ±åèªªæ˜</h3>
      <div id="noticeContent" style="font-weight: bold; line-height: 1.6;"></div>
    </div>

    <div class="card">
      <div class="controls">
        <select id="classSelect"><option value="">-- è«‹é¸æ“‡ç­ç´š --</option></select>
        <button class="btn blue" onclick="queryStudents()">ğŸ” æŸ¥è©¢åå–®</button>
        <button class="btn yellow" onclick="fetchSignedList()">ğŸ“„ å·²å ±ååå–®</button>
        <button class="btn outline" onclick="showAdminModal()">âš™ï¸ è¨­å®š</button>
      </div>
      
      <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:3px solid var(--primary); padding-bottom:10px; margin-top: 25px;">
        <h3 id="listTitle" style="margin:0; color:var(--primary); font-size: 22px;">ç­ç´šå­¸ç”Ÿåˆ—è¡¨</h3>
      </div>
      
      <!-- å¡ç‰‡å¼å­¸ç”Ÿæ¸…å–®å®¹å™¨ -->
      <div id="studentListContainer" class="stu-list">
        <div style="text-align:center; padding: 40px 20px; color: var(--text-muted); font-weight: bold; font-size: 18px; background: #f8fafc; border-radius: 16px; border: 2px dashed #cbd5e1;">
          ğŸ‘† è«‹å…ˆç”±ä¸Šæ–¹é¸æ“‡ç­ç´šä¸¦é»æ“ŠæŸ¥è©¢
        </div>
      </div>
    </div>
  </div>

  <!-- å³å´ï¼šå¾…æäº¤çµ„éšŠåå–® -->
  <div class="col-right col-side">
    <div class="card" style="border: 3px solid var(--primary); position: sticky; top: 20px;">
      <h3 style="margin-top:0; color:var(--primary); font-size: 22px; display: flex; align-items: center; gap: 8px;">
        ğŸ“ å¾…é€å‡ºè®Šæ›´å€
      </h3>
      
      <div class="group-info" id="groupRuleInfo">
        è¨­å®šï¼š1çµ„3 äººï¼Œæ­£å–1çµ„ã€å‚™å–1 çµ„
      </div>

      <div class="selected-list" id="selectedListContainer">
         <div style="text-align:center; color:var(--text-muted); margin-top:40px; font-weight: bold;">
           å°šç„¡å¾…è™•ç†è®Šæ›´<br>è«‹å¾å·¦å´é»é¸åŠ å…¥ã€æ›¿æ›æˆ–å–æ¶ˆ
         </div>
      </div>

      <!-- æ¡Œæ©Ÿç‰ˆæŒ‰éˆ•å€ -->
      <div class="desktop-submit-area" style="margin-top: 25px; display: flex; gap: 12px;">
        <button class="btn green" style="flex:2; font-size: 18px;" onclick="submitGroup()">ğŸš€ é€å‡ºå ±åè®Šæ›´</button>
        <button class="btn outline" style="flex:1;" onclick="clearPendingActions()">æ¸…ç©ºé‡ç½®</button>
      </div>
    </div>
  </div>
</div>

<!-- æ‰‹æ©Ÿç‰ˆå°ˆå±¬ï¼šç½®åº•æ“ä½œåˆ— -->
<div class="mobile-bottom-bar">
  <div style="display: flex; flex-direction: column;">
    <span style="font-size: 14px; color: var(--text-muted); font-weight: bold;">ç›®å‰å¾…é€å‡º</span>
    <span style="font-size: 20px; font-weight: 900; color: var(--primary);">
      <span id="mobileSelectedCount">0</span> ç­†è®Šæ›´
    </span>
  </div>
  <div style="display: flex; gap: 10px;">
    <button class="btn outline" style="padding: 10px 15px;" onclick="clearPendingActions()">æ¸…ç©º</button>
    <button class="btn green" style="padding: 12px 24px; font-size: 18px;" onclick="submitGroup()">é€å‡º</button>
  </div>
</div>

<!-- æ›¿æ›éšŠå“¡ Modal -->
<div class="modal-overlay" id="replaceModal">
  <div class="modal">
    <h3 style="margin-top:0; color: var(--warning);">ğŸ”„ æ›¿æ›éšŠå“¡</h3>
    <div style="text-align: left; margin: 15px 0;">
      <p style="font-size: 16px; margin-bottom: 8px;"><strong>åŸéšŠå“¡ï¼š</strong> <span id="replaceOldName" style="color:var(--danger); font-weight:bold;"></span></p>
      <p style="font-size: 16px; margin-bottom: 4px;"><strong>è«‹é¸æ“‡æ›¿æ›ç‚ºï¼š</strong></p>
      <select id="replaceNewStudentSelect">
          <!-- é¸é …ç”± JS å‹•æ…‹ç”¢ç”Ÿ -->
      </select>
    </div>
    <div style="display: flex; gap: 10px; margin-top: 25px;">
      <button class="btn outline" style="flex:1;" onclick="document.getElementById('replaceModal').style.display='none'">å–æ¶ˆ</button>
      <button class="btn yellow" style="flex:1;" onclick="confirmReplace()">ç¢ºèªæ›¿æ›</button>
    </div>
  </div>
</div>

<!-- ç®¡ç†å“¡å¯†ç¢¼è¦–çª— -->
<div class="modal-overlay" id="adminModal">
  <div class="modal">
    <h3 style="margin-top:0; color: var(--danger);">ç®¡ç†å“¡é©—è­‰</h3>
    <p style="color: var(--text-muted); font-size: 14px; margin:0;">é‡è¨­è³‡æ–™å°ˆç”¨</p>
    <input type="password" id="adminPwd" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" maxlength="6" inputmode="numeric">
    <div style="display: flex; gap: 10px; margin-top: 10px;">
      <button class="btn outline" style="flex:1;" onclick="document.getElementById('adminModal').style.display='none'">å–æ¶ˆ</button>
      <button class="btn red" style="flex:1;" onclick="verifyAdmin()">ç¢ºå®š</button>
    </div>
  </div>
</div>

<script>
  // ==========================================
  // âš ï¸ éƒ¨ç½²è¨­å®šå€ï¼šè«‹æ›¿æ›ç‚ºæ‚¨çš„ GAS ç¶²é æ‡‰ç”¨ç¨‹å¼ç¶²å€
  // ==========================================
  const GAS_API_URL = "https://script.google.com/macros/s/AKfycbww9F0m7-6g3d9toQ8KVBheIHVAjvstSWAcf2lYUs5vjjQFHay2i_01VjnJ2-snLptk/exec"; 
  
  // ç³»çµ±å…¨åŸŸè®Šæ•¸
  let sysConfig = { groupSize: 3, waitlistCount: 1 };
  let currentClassStudents = []; 
  
  // å­˜æ”¾æ‰€æœ‰å¾…è™•ç†çš„è®Šæ›´ä»»å‹™
  // { id, type: 'ADD'|'REPLACE'|'CANCEL', student/oldStudent/newStudent }
  let pendingActions = []; 
  let replaceTargetRowIndex = null; // ç´€éŒ„ç›®å‰é–‹å•Ÿ Modal æ™‚çš„å°è±¡

  // ================== UI è¼”åŠ©å‡½å¼ ==================
  function showLoader(show) { document.getElementById('loader').style.display = show ? 'flex' : 'none'; }
  function showToast(msg, type='success') {
    const el = document.getElementById('toast');
    el.textContent = msg; el.className = 'toast ' + type + ' show';
    setTimeout(() => el.classList.remove('show'), 3000);
  }

  // ================== åˆå§‹åŒ–è¼‰å…¥ ==================
  window.onload = () => {
    showLoader(true);
    fetch(`${GAS_API_URL}?action=getInitData`)
      .then(res => res.json())
      .then(data => {
        if(data.error) throw new Error(data.error);
        
        document.getElementById('pageTitle').textContent = data.title;
        document.title = data.title;
        
        sysConfig.groupSize = data.groupSize || 3;
        sysConfig.waitlistCount = data.waitlistCount || 1;
        updateGroupRuleText();

        if(data.notices && data.notices.length > 0) {
          document.getElementById('noticeCard').style.display = 'block';
          document.getElementById('noticeContent').innerHTML = data.notices.map(n => `<p style="margin: 6px 0;">${n}</p>`).join('');
        }

        const select = document.getElementById('classSelect');
        data.classes.forEach(c => {
          let opt = document.createElement('option');
          opt.value = c; opt.text = c + " ç­";
          select.appendChild(opt);
        });
        
        showLoader(false);
      })
      .catch(err => {
        showLoader(false);
        showToast("åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹ç¢ºèª GAS ç¶²å€: " + err.message, "error");
      });
  };

  function updateGroupRuleText() {
    document.getElementById('groupRuleInfo').textContent = 
      `ğŸ“Œ è¨­å®šï¼š1çµ„${sysConfig.groupSize}äººï¼Œæ­£å–1çµ„ã€å‚™å–${sysConfig.waitlistCount}çµ„`;
  }

  // ================== æŸ¥è©¢ç­ç´šå­¸ç”Ÿ ==================
  function queryStudents() {
    const cls = document.getElementById('classSelect').value;
    if(!cls) return showToast("è«‹å…ˆé¸æ“‡ç­ç´š", "error");

    showLoader(true);
    fetch(`${GAS_API_URL}?action=queryByClass&className=${encodeURIComponent(cls)}`)
      .then(res => res.json())
      .then(data => {
        showLoader(false);
        if(data.error) throw new Error(data.error);
        
        currentClassStudents = data.rows;
        document.getElementById('listTitle').textContent = `${cls} ç­ç´šå­¸ç”Ÿåˆ—è¡¨`;
        renderStudentList();
      })
      .catch(err => {
        showLoader(false); showToast("æŸ¥è©¢å¤±æ•—: " + err.message, "error");
      });
  }

  // æ¸²æŸ“å·¦å´å¡ç‰‡æ¸…å–® (å‹•æ…‹é¡¯ç¤ºå¾…è¾¦ç‹€æ…‹)
  function renderStudentList() {
    const container = document.getElementById('studentListContainer');
    container.innerHTML = '';
    
    if(currentClassStudents.length === 0) {
      container.innerHTML = `<div style="text-align:center; padding: 40px; color:#64748b; font-weight:bold;">æ­¤ç­ç´šæŸ¥ç„¡å­¸ç”Ÿè³‡æ–™</div>`;
      return;
    }

    currentClassStudents.forEach(stu => {
      // æª¢æŸ¥æ­¤å­¸ç”Ÿæ˜¯å¦ç‰½æ¶‰åœ¨å¾…è™•ç†çš„ Action ä¸­
      const isPendingAdd = pendingActions.some(a => a.type === 'ADD' && a.student.rowIndex === stu.rowIndex);
      const isPendingReplaceIn = pendingActions.some(a => a.type === 'REPLACE' && a.newStudent.rowIndex === stu.rowIndex);
      const isPendingReplaceOut = pendingActions.some(a => a.type === 'REPLACE' && a.oldStudent.rowIndex === stu.rowIndex);
      const isPendingCancel = pendingActions.some(a => a.type === 'CANCEL' && a.student.rowIndex === stu.rowIndex);
      
      const isAlreadySigned = stu.E == 1 || stu.E == '1'; // è³‡æ–™åº«çœŸå¯¦ç‹€æ…‹

      let cardClass = 'stu-card';
      let statusHtml = '';
      let btnHtml = '';

      if (isPendingAdd) {
          cardClass += ' selected';
          statusHtml = '<span class="status-text" style="color:var(--primary);">ğŸ”µ å¾…åŠ å…¥</span>';
          btnHtml = `<button class="action-btn remove" onclick="removeActionByStudent(${stu.rowIndex}, event)">å–æ¶ˆæ“ä½œ</button>`;
      } else if (isPendingReplaceIn) {
          cardClass += ' selected';
          statusHtml = '<span class="status-text" style="color:var(--warning);">ğŸ”„ å¾…æ›¿æ›å…¥</span>';
          btnHtml = `<button class="action-btn outline" onclick="removeActionByStudent(${stu.rowIndex}, event)">æ’¤éŠ·</button>`;
      } else if (isPendingReplaceOut) {
          cardClass += ' disabled';
          statusHtml = '<span class="status-text" style="color:var(--danger);">ğŸ”„ å°‡è¢«æ›¿æ›</span>';
          btnHtml = `<button class="action-btn outline" onclick="removeActionByStudent(${stu.rowIndex}, event)">æ’¤éŠ·</button>`;
      } else if (isPendingCancel) {
          cardClass += ' disabled';
          statusHtml = '<span class="status-text" style="color:var(--danger);">âŒ å°‡è¢«å–æ¶ˆ</span>';
          btnHtml = `<button class="action-btn outline" onclick="removeActionByStudent(${stu.rowIndex}, event)">æ’¤éŠ·</button>`;
      } else if (isAlreadySigned) {
          cardClass += ' signed';
          statusHtml = `<span class="status-text" style="color:var(--success);">ğŸ”’ ${stu.F || 'å·²å ±å'}</span>`;
          btnHtml = `
            <div style="display:flex; gap:8px;">
              <button class="action-btn" style="background:var(--warning); color:#fff;" onclick="openReplaceModal(${stu.rowIndex}, event)">æ›¿æ›</button>
              <button class="action-btn remove" onclick="addAction('CANCEL', ${stu.rowIndex}, event)">å–æ¶ˆ</button>
            </div>`;
      } else {
          statusHtml = '<span class="status-text" style="color:var(--text-muted);">âšª æœªå ±å</span>';
          btnHtml = `<button class="action-btn add" onclick="addAction('ADD', ${stu.rowIndex}, event)">åŠ å…¥ +</button>`;
      }

      const div = document.createElement('div');
      div.className = cardClass;
      
      // å¡ç‰‡æ•´é«”é»æ“Šäº‹ä»¶
      div.onclick = (e) => { 
        if (!isPendingReplaceOut && !isPendingCancel && !isAlreadySigned && !isPendingReplaceIn && !isPendingAdd) {
            addAction('ADD', stu.rowIndex, e);
        } else if (isPendingAdd || isPendingReplaceIn || isPendingReplaceOut || isPendingCancel) {
            removeActionByStudent(stu.rowIndex, e);
        }
      };
      
      div.innerHTML = `
        <div class="stu-info">
          <div class="stu-meta">åº§è™Ÿï¼š${stu.B}</div>
          <div class="stu-name">${stu.C}</div>
        </div>
        <div class="stu-status-area">
          ${statusHtml}
          ${btnHtml}
        </div>
      `;
      container.appendChild(div);
    });
  }

  // ================== æ–°å¢ã€æ›¿æ›ã€å–æ¶ˆä»»å‹™ç®¡ç† ==================

  // 1. æ–°å¢ä»»å‹™ (åŠ å…¥ æˆ– å–æ¶ˆ)
  function addAction(type, rowIndex, event) {
      if(event) event.stopPropagation();
      const stu = currentClassStudents.find(s => s.rowIndex === rowIndex);

      if (type === 'ADD') {
          // æª¢æŸ¥é¸å–äººæ•¸æ˜¯å¦å·²é”ä¸Šé™
          const currentAddCount = pendingActions.filter(a => a.type === 'ADD').length;
          const maxTotal = sysConfig.groupSize + (sysConfig.groupSize * sysConfig.waitlistCount);
          if (currentAddCount >= maxTotal) {
              return showToast(`å–®æ¬¡åŠ å…¥å·²é”ä¸Šé™ (${maxTotal}äºº)ï¼`, "error");
          }
          pendingActions.push({ id: 'ACT_' + Date.now(), type: 'ADD', student: stu });
      } else if (type === 'CANCEL') {
          pendingActions.push({ id: 'ACT_' + Date.now(), type: 'CANCEL', student: stu });
      }

      refreshAddLabels();
      renderStudentList();
      renderPendingActions();
  }

  // 2. æ›¿æ›ä»»å‹™ (é€é Modal)
  function openReplaceModal(rowIndex, event) {
      if(event) event.stopPropagation();
      replaceTargetRowIndex = rowIndex;
      const oldStu = currentClassStudents.find(s => s.rowIndex === rowIndex);
      document.getElementById('replaceOldName').textContent = oldStu.C;

      // ç”¢ç”Ÿé¸é …ï¼šéæ¿¾æ‰å·²å ±åã€èˆ‡å·²åœ¨å¾…è¾¦æ¸…å–®å…§çš„å­¸ç”Ÿ
      const select = document.getElementById('replaceNewStudentSelect');
      select.innerHTML = '<option value="">-- è«‹é¸æ“‡æ›¿æ›å­¸ç”Ÿ --</option>';

      let optionCount = 0;
      currentClassStudents.forEach(stu => {
          const isRegistered = (stu.E == 1 || stu.E == '1');
          const isPending = pendingActions.some(a =>
              (a.type === 'ADD' && a.student.rowIndex === stu.rowIndex) ||
              (a.type === 'REPLACE' && a.newStudent.rowIndex === stu.rowIndex)
          );
          if (!isRegistered && !isPending) {
              select.innerHTML += `<option value="${stu.rowIndex}">${stu.B}è™Ÿ - ${stu.C}</option>`;
              optionCount++;
          }
      });

      if(optionCount === 0) {
          select.innerHTML = '<option value="">(ç„¡å¯æ›¿æ›çš„å­¸ç”Ÿï¼Œçš†å·²å ±åæˆ–é¸å–)</option>';
      }

      document.getElementById('replaceModal').style.display = 'flex';
  }

  function confirmReplace() {
      const select = document.getElementById('replaceNewStudentSelect');
      if(!select.value) return showToast('è«‹é¸æ“‡è¦æ›¿æ›çš„æ–°å­¸ç”Ÿ', 'error');

      const newStuRow = parseInt(select.value);
      const oldStu = currentClassStudents.find(s => s.rowIndex === replaceTargetRowIndex);
      const newStu = currentClassStudents.find(s => s.rowIndex === newStuRow);

      pendingActions.push({
          id: 'ACT_' + Date.now(),
          type: 'REPLACE',
          oldStudent: oldStu,
          newStudent: newStu
      });

      document.getElementById('replaceModal').style.display = 'none';
      renderStudentList();
      renderPendingActions();
  }

  // 3. æ’¤éŠ·å¾…è™•ç†ä»»å‹™
  function removeActionById(actionId) {
      pendingActions = pendingActions.filter(a => a.id !== actionId);
      refreshAddLabels();
      renderStudentList();
      renderPendingActions();
  }

  function removeActionByStudent(rowIndex, event) {
      if(event) event.stopPropagation();
      pendingActions = pendingActions.filter(a => {
          if (a.type === 'ADD' && a.student.rowIndex === rowIndex) return false;
          if (a.type === 'REPLACE' && (a.oldStudent.rowIndex === rowIndex || a.newStudent.rowIndex === rowIndex)) return false;
          if (a.type === 'CANCEL' && a.student.rowIndex === rowIndex) return false;
          return true;
      });
      refreshAddLabels();
      renderStudentList();
      renderPendingActions();
  }

  function clearPendingActions() {
      if(pendingActions.length === 0) return;
      if(confirm("ç¢ºå®šè¦æ¸…ç©ºç›®å‰æ‰€æœ‰å¾…è™•ç†çš„è®Šæ›´å—ï¼Ÿ")) {
          pendingActions = [];
          renderStudentList();
          renderPendingActions();
      }
  }

  // ================== å³å´å¾…é€å‡ºæ¸…å–®æ¸²æŸ“ ==================
  
  // è¨ˆç®— ADD ä»»å‹™çš„æ–°ç”Ÿæ¨™ç±¤(æ­£å–/å‚™å–)
  function refreshAddLabels() {
      const addActions = pendingActions.filter(a => a.type === 'ADD');
      const mainClass = addActions.length > 0 ? addActions[0].student.A : '';
      addActions.forEach((a, idx) => {
          if (idx < sysConfig.groupSize) {
              a.targetLabel = `${mainClass}-æ­£å–`;
          } else {
              const waitlistNum = Math.floor((idx - sysConfig.groupSize) / sysConfig.groupSize) + 1;
              a.targetLabel = `${mainClass}-å‚™å–${waitlistNum}`;
          }
      });
  }

  function renderPendingActions() {
      const container = document.getElementById('selectedListContainer');
      document.getElementById('mobileSelectedCount').innerText = pendingActions.length;

      if (pendingActions.length === 0) {
          container.innerHTML = `<div style="text-align:center; color:var(--text-muted); margin-top:40px; font-weight:bold;">å°šç„¡å¾…è™•ç†è®Šæ›´<br>è«‹å¾å·¦å´é»é¸åŠ å…¥ã€æ›¿æ›æˆ–å–æ¶ˆ</div>`;
          return;
      }

      container.innerHTML = pendingActions.map(action => {
          if (action.type === 'ADD') {
              const tagColor = action.targetLabel.includes('æ­£å–') ? 'main' : 'wait';
              return `
              <div class="selected-item" style="border-left-color: var(--success);">
                  <div style="display:flex; flex-direction:column; gap:6px;">
                      <div style="font-size:14px; font-weight:bold; color:var(--success);">ğŸ”µ åŠ å…¥æ–°æˆå“¡</div>
                      <div>
                          <span style="font-size:16px; font-weight:900; color:var(--text-main); margin-right:8px;">${action.student.C}</span>
                          <span class="tag ${tagColor}">${action.targetLabel}</span>
                      </div>
                  </div>
                  <button class="remove-btn-small" onclick="removeActionById('${action.id}')">âœ• ç§»é™¤</button>
              </div>`;
          } else if (action.type === 'REPLACE') {
              return `
              <div class="selected-item" style="border-left-color: var(--warning);">
                  <div style="display:flex; flex-direction:column; gap:6px;">
                      <div style="font-size:14px; font-weight:bold; color:var(--warning);">ğŸ”„ æ›¿æ›éšŠå“¡</div>
                      <div style="font-size:16px; font-weight:900; color:var(--text-main);">
                          <del style="color:var(--text-muted);">${action.oldStudent.C}</del> â¡ï¸ <span style="color:var(--primary);">${action.newStudent.C}</span>
                      </div>
                      <div style="font-size:13px; color:var(--text-muted); font-weight:bold;">ç¹¼æ‰¿ï¼š${action.oldStudent.F}</div>
                  </div>
                  <button class="remove-btn-small" onclick="removeActionById('${action.id}')">âœ• ç§»é™¤</button>
              </div>`;
          } else if (action.type === 'CANCEL') {
              return `
              <div class="selected-item" style="border-left-color: var(--danger);">
                  <div style="display:flex; flex-direction:column; gap:6px;">
                      <div style="font-size:14px; font-weight:bold; color:var(--danger);">âŒ å–æ¶ˆå ±å</div>
                      <div style="font-size:16px; font-weight:900; color:var(--text-main);">
                          <del>${action.student.C}</del>
                      </div>
                  </div>
                  <button class="remove-btn-small" onclick="removeActionById('${action.id}')">âœ• ç§»é™¤</button>
              </div>`;
          }
      }).join('');
  }

  // ================== é€å‡ºæ‰€æœ‰ä»»å‹™å„²å­˜ ==================
  function submitGroup() {
    if (pendingActions.length === 0) return showToast("ç›®å‰æ²’æœ‰å¾…é€å‡ºçš„è®Šæ›´ï¼", "error");

    const payload = [];
    pendingActions.forEach(action => {
        if (action.type === 'ADD') {
            payload.push({ rowIndex: action.student.rowIndex, E: 1, F: action.targetLabel });
        } else if (action.type === 'REPLACE') {
            payload.push({ rowIndex: action.oldStudent.rowIndex, E: 0, F: '' }); // èˆŠå­¸ç”Ÿå–æ¶ˆ
            payload.push({ rowIndex: action.newStudent.rowIndex, E: 1, F: action.oldStudent.F }); // æ–°å­¸ç”Ÿè£œä¸Š
        } else if (action.type === 'CANCEL') {
            payload.push({ rowIndex: action.student.rowIndex, E: 0, F: '' }); // å­¸ç”Ÿå–æ¶ˆ
        }
    });

    showLoader(true);
    fetch(GAS_API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify({ action: 'saveGroupSignup', payload: payload })
    })
    .then(res => res.json())
    .then(data => {
      showLoader(false);
      if(data.error) throw new Error(data.error);
      
      showToast("ğŸ‰ è®Šæ›´å·²æˆåŠŸé€å‡ºå„²å­˜ï¼");
      pendingActions = []; 
      renderPendingActions();
      if(document.getElementById('classSelect').value) queryStudents(); 
    })
    .catch(err => {
      showLoader(false); showToast("å„²å­˜å¤±æ•—: " + err.message, "error");
    });
  }

  // ================== æª¢è¦–å·²å ±åæ¸…å–® ==================
  function fetchSignedList() {
    showLoader(true);
    fetch(`${GAS_API_URL}?action=getSignedList`)
      .then(res => res.json())
      .then(data => {
        showLoader(false);
        if(data.error) throw new Error(data.error);
        if(!data.rows || data.rows.length === 0) return showToast("ç›®å‰ç„¡äººå ±å", "info");

        // åµæ¸¬ã€Œçµ„åˆ¥ã€æ¬„ä½åœ¨å“ªä¸€æ¬„
        const groupColIdx = data.headers.findIndex(h => h.includes('çµ„åˆ¥'));

        const thead = `<tr>${data.headers.map(h => `<th>${h}</th>`).join('')}</tr>`;
        const tbody = data.rows.map(r => `<tr>${r.map((c, i) => {
            // å¦‚æœé€™æ¬„æ˜¯çµ„åˆ¥ï¼Œä¸”æœ‰è³‡æ–™ï¼Œå°±è½‰æ›ç‚ºæ¼‚äº®çš„æ¨™ç±¤
            if (i === groupColIdx && c) {
                let tagClass = c.includes('æ­£å–') ? 'main' : (c.includes('å‚™å–') ? 'wait' : 'primary');
                return `<td><span class="tag ${tagClass}" style="display:inline-block; padding: 6px 12px; font-size:14px;">${c}</span></td>`;
            }
            return `<td>${c}</td>`;
        }).join('')}</tr>`).join('');
        
        document.getElementById('listTitle').textContent = "å…¨æ ¡å·²å ±ååå–®";
        document.getElementById('studentListContainer').innerHTML = `
          <div style="overflow-x:auto; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05);">
            <table class="vibrant-table">
              <thead>${thead}</thead>
              <tbody>${tbody}</tbody>
            </table>
          </div>
        `;
      })
      .catch(err => {
        showLoader(false); showToast("å–å¾—åå–®å¤±æ•—: " + err.message, "error");
      });
  }

  // ================== ç®¡ç†å“¡é€²éšè¨­å®š ==================
  function showAdminModal() {
    document.getElementById('adminPwd').value = '';
    document.getElementById('adminModal').style.display = 'flex';
  }

  function verifyAdmin() {
    const pwd = document.getElementById('adminPwd').value;
    if(pwd !== '000000') {
      showToast("å¯†ç¢¼éŒ¯èª¤", "error");
      return;
    }
    document.getElementById('adminModal').style.display = 'none';
    
    if(confirm("ç®¡ç†å“¡æ‚¨å¥½ï¼\næ˜¯å¦è¦æ¸…é™¤ã€Œæ‰€æœ‰å­¸ç”Ÿã€çš„å ±åç´€éŒ„(æ¢å¾©é è¨­å€¼)ï¼Ÿ\nâš ï¸ è­¦å‘Šï¼šæ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼")) {
      showLoader(true);
      fetch(GAS_API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify({ action: 'resetDefaults' })
      })
      .then(res => res.json())
      .then(data => {
        showLoader(false);
        if(data.error) throw new Error(data.error);
        showToast("å·²æ¢å¾©é è¨­å€¼ï¼æ‰€æœ‰åå–®å·²æ¸…ç©ºã€‚");
        currentClassStudents = [];
        pendingActions = [];
        renderPendingActions();
        document.getElementById('listTitle').textContent = "ç­ç´šå­¸ç”Ÿåˆ—è¡¨";
        document.getElementById('studentListContainer').innerHTML = `<div style="text-align:center; padding: 40px; color:#64748b; font-weight:bold;">è«‹é‡æ–°æŸ¥è©¢ç­ç´š</div>`;
      })
      .catch(err => {
        showLoader(false); showToast("é‡è¨­å¤±æ•—: " + err.message, "error");
      });
    }
  }
</script>
</body>
</html>