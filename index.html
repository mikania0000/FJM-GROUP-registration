<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>å ±åç³»çµ± v2.6</title>
<style>
  :root {
    --primary: #2563eb;       
    --primary-light: #dbeafe; 
    --success: #059669;       
    --success-light: #dcfce7;
    --danger: #e11d48;        
    --warning: #d97706;       
    --warning-light: #fef3c7;
    --info: #0ea5e9;          
    --bg-page: #f1f5f9;       
    --card-bg: #ffffff;
    --text-main: #0f172a;
    --text-muted: #64748b;
    --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
    --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
    --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
  }

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  
  html, body { height: 100%; margin: 0; }
  body {
    background: var(--bg-page); color: var(--text-main);
    font-family: system-ui, -apple-system, "Noto Sans TC", sans-serif;
    padding-bottom: 40px; 
  }
  
  .wrap { max-width: 800px; margin: 20px auto; padding: 0 16px; }

  .header-title {
    font-size: 32px; font-weight: 900; text-align: center; margin-bottom: 20px;
    background: linear-gradient(135deg, #1e3a8a, #3b82f6); color: #fff;
    padding: 20px; border-radius: 16px; box-shadow: var(--shadow-md);
    letter-spacing: 2px;
  }

  /* ç‰ˆæœ¬è™Ÿæ¨£å¼ */
  .version-text {
    font-size: 16px;
    font-weight: normal;
    opacity: 0.8;
    margin-left: 8px;
    letter-spacing: normal;
  }

  .toast {
    position: fixed; left: 50%; top: 20px; transform: translateX(-50%);
    color: #fff; padding: 14px 28px; border-radius: 999px; box-shadow: var(--shadow-lg);
    z-index: 1700; display: none; font-weight: 800; font-size: 16px; white-space: nowrap;
  }
  .toast.show { display: block; animation: popDown 0.3s ease forwards; }
  @keyframes popDown { from { top: -20px; opacity: 0; } to { top: 20px; opacity: 1; } }
  .toast.success { background: var(--success); }
  .toast.error { background: var(--danger); }
  .toast.info { background: var(--info); }

  #loader {
    position: fixed; inset: 0; background: rgba(255,255,255,0.85); z-index: 1600;
    display: none; justify-content: center; align-items: center; flex-direction: column;
  }
  .spinner {
    width: 50px; height: 50px; border: 5px solid var(--primary-light);
    border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  .card {
    background: var(--card-bg); border-radius: 16px;
    padding: 20px; box-shadow: var(--shadow-md); margin-bottom: 20px;
  }

  .controls { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; justify-content: space-between;}
  .controls-left { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
  select.main-select { 
    padding: 12px 16px; border-radius: 12px; border: 2px solid #cbd5e1; 
    font-size: 16px; min-width: 140px; font-weight: bold; outline: none; background: white;
  }
  select.main-select:focus { border-color: var(--primary); }
  
  .btn { 
    padding: 12px 20px; border: none; border-radius: 12px; color: #fff; 
    font-size: 16px; cursor: pointer; font-weight: 800; transition: all 0.2s;
    display: inline-flex; align-items: center; justify-content: center;
  }
  .btn:active { transform: scale(0.95); }
  .btn.blue { background: var(--primary); }
  .btn.green { background: var(--success); }
  .btn.red { background: var(--danger); }
  .btn.yellow { background: var(--warning); color: #fff; }
  .btn.outline { background: transparent; border: 2px solid var(--danger); color: var(--danger); }
  .btn.outline-gray { background: transparent; border: 2px solid #94a3b8; color: #475569; }

  .notice-wrapper { display: flow-root; }
  .notice-img { float: right; max-width: 250px; width: 40%; margin: 5px 0 15px 20px; border-radius: 10px; box-shadow: var(--shadow-md); border: 3px solid #a7f3d0; object-fit: cover; background: #fff; }

  .sticky-stats {
    position: sticky; top: 10px; z-index: 100;
    background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
    border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    padding: 16px; margin-bottom: 20px; border: 2px solid var(--primary);
    display: none; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px;
  }
  .stats-badges { display: flex; gap: 12px; flex-wrap: wrap; }
  .stat-badge { padding: 8px 16px; border-radius: 999px; font-weight: 900; font-size: 16px; display: flex; align-items: center; gap: 6px; }
  .stat-badge.main { background: var(--success-light); color: #166534; border: 1px solid #86efac; }
  .stat-badge.wait { background: var(--warning-light); color: #92400e; border: 1px solid #fcd34d; }
  .stat-count { font-size: 18px; }

  .stu-list { display: flex; flex-direction: column; gap: 10px; margin-top: 10px; }
  .stu-card {
    display: flex; align-items: center; justify-content: space-between;
    padding: 12px 16px; background: var(--card-bg); border-radius: 12px;
    border: 2px solid #e2e8f0; transition: all 0.2s;
  }
  .stu-card.status-main { border-color: var(--success); background: #f0fdf4; box-shadow: 0 2px 8px rgba(5, 150, 105, 0.15); }
  .stu-card.status-wait { border-color: var(--warning); background: #fffbeb; box-shadow: 0 2px 8px rgba(217, 119, 6, 0.15); }
  .stu-card.status-cross { background: #f8fafc; border-color: #cbd5e1; opacity: 0.8; }
  
  .stu-info { display: flex; flex-direction: column; gap: 2px; }
  .stu-meta { font-size: 13px; color: var(--text-muted); font-weight: bold; }
  .stu-name { font-size: 20px; font-weight: 900; color: var(--text-main); }
  
  .row-select {
    padding: 10px 14px; border-radius: 10px; font-size: 16px; font-weight: 900;
    border: 2px solid #cbd5e1; cursor: pointer; outline: none; appearance: none;
    text-align: center; min-width: 110px; background: white; transition: 0.2s;
  }
  .row-select.sel-main { background: var(--success); color: white; border-color: var(--success); }
  .row-select.sel-wait { background: var(--warning); color: white; border-color: var(--warning); }
  .row-select:focus { transform: scale(1.05); }

  .vibrant-table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 600px; }
  .vibrant-table th { background: var(--primary); color: white; padding: 16px; text-align: left; font-size: 16px;}
  .vibrant-table td { padding: 16px; background: white; border-bottom: 1px solid #e2e8f0; font-size: 16px; font-weight: bold; vertical-align: middle;}
  .vibrant-table tr:hover td { background: #f8fafc; }
  .vibrant-table th:first-child { border-top-left-radius: 12px; }
  .vibrant-table th:last-child { border-top-right-radius: 12px; }
  .tag { border-radius: 8px; font-size: 14px; font-weight: 900; padding: 6px 12px; color: white; letter-spacing: 1px; display:inline-block;}
  .tag.main { background: var(--success); }
  .tag.wait { background: var(--warning); }
  .tag.primary { background: var(--primary); }
  .tag.gray { background: var(--text-muted); }

  .modal-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);
    display: none; justify-content: center; align-items: center; z-index: 1800; overflow-y: auto; padding: 20px;
  }
  .modal { background: #fff; padding: 30px; border-radius: 20px; width: 100%; max-width: 400px; text-align: center; box-shadow: var(--shadow-lg); position: relative;}
  .modal-large { max-width: 600px; }
  .modal input { width: 100%; padding: 12px; margin: 10px 0 20px; border: 2px solid #cbd5e1; border-radius: 10px; font-size: 16px; font-weight: bold; text-align: center; }

  .adv-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 14px; margin-top: 20px; }
  @media (max-width: 480px) { .adv-grid { grid-template-columns: 1fr; } }
  .btn-adv { padding: 16px 12px; border-radius: 16px; color: white; font-weight: bold; font-size: 16px; border: none; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: transform 0.2s;}
  .btn-adv:active { transform: scale(0.95); }
  .btn-adv-red { background: linear-gradient(135deg, #ef4444, #b91c1c); }
  .btn-adv-blue { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
  .btn-adv-green { background: linear-gradient(135deg, #10b981, #047857); }
  .btn-adv-teal { background: linear-gradient(135deg, #14b8a6, #0f766e); }
  .btn-adv-purple { background: linear-gradient(135deg, #8b5cf6, #5b21b6); }
  .btn-adv-orange { background: linear-gradient(135deg, #f59e0b, #b45309); }
  .btn-adv-slate { background: linear-gradient(135deg, #475569, #1e293b); }
  .btn-adv-gray { background: #f8fafc; color: #64748b; border: 2px dashed #cbd5e1; box-shadow: none; }
  
  .settings-form { display: flex; flex-direction: column; gap: 12px; text-align: left; max-height: 60vh; overflow-y: auto; padding-right: 10px;}
  .settings-form label { font-weight: bold; color: var(--text-main); font-size: 14px; margin-bottom: -5px;}
  .settings-form input, .settings-form select { width: 100%; text-align: left; margin: 0; padding: 10px; border: 2px solid #cbd5e1; border-radius: 8px; font-size: 16px; font-weight:bold; background:white; }
  .settings-form input:focus, .settings-form select:focus { border-color: var(--primary); outline:none;}
  .cross-member-row { display: flex; gap: 10px; margin-bottom: 12px; text-align: left;}
  .cross-member-row select { width: 50%; padding: 10px; border-radius: 8px; font-size: 15px;}

  @media (max-width: 768px) {
    .notice-img { max-width: 140px; width: 45%; margin: 5px 0 5px 12px; }
  }
</style>
</head>
<body>

<div id="loader">
  <div class="spinner"></div>
  <div style="margin-top: 15px; font-weight: bold; color: var(--primary); font-size: 18px;">ç³»çµ±è¼‰å…¥ä¸­...</div>
</div>
<div id="toast" class="toast"></div>

<div class="wrap">
  
  <div class="header-title" id="pageTitle">
    å ±åç³»çµ± <span class="version-text">v2.6</span>
  </div>

  <div class="card" id="noticeCard" style="background:#ecfdf5; border:2px solid #a7f3d0; display:none;">
    <h3 style="margin-top:0; color:var(--success);">ğŸ“Œ å ±åèªªæ˜</h3>
    <div id="noticeContent" class="notice-wrapper" style="font-weight: bold; line-height: 1.6;"></div>
  </div>

  <div class="card">
    <div class="controls">
      <div class="controls-left">
        <select id="classSelect" class="main-select" onchange="queryStudents()">
          <option value="">-- è«‹é¸æ“‡ç­ç´š --</option>
        </select>
        <button class="btn yellow" onclick="fetchSignedList()">ğŸ“„ å·²å ±ååå–®</button>
      </div>
      <button class="btn outline" onclick="showAdminModal()">âš™ï¸ é€²éšè¨­å®š</button>
    </div>
    
    <!-- ç½®é ‚ç‹€æ…‹çµ±è¨ˆåˆ— -->
    <div class="sticky-stats" id="statsBar">
      <div class="stats-badges" id="statsBadgesContainer">
        <!-- å‹•æ…‹ç”¢ç”Ÿ -->
      </div>
      <button class="btn green" style="font-size: 18px; padding: 12px 24px;" onclick="submitGroup()">ğŸš€ é€å‡ºå„²å­˜</button>
    </div>

    <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:3px solid var(--primary); padding-bottom:10px; margin-top: 20px;">
      <h3 id="listTitle" style="margin:0; color:var(--primary); font-size: 22px;">åå–®åˆ—è¡¨</h3>
    </div>
    
    <div id="studentListContainer" class="stu-list">
      <div style="text-align:center; padding: 40px 20px; color: var(--text-muted); font-weight: bold; font-size: 18px; background: #f8fafc; border-radius: 16px; border: 2px dashed #cbd5e1;">
        ğŸ‘† è«‹å…ˆç”±ä¸Šæ–¹é¸æ“‡ç­ç´šï¼Œæˆ–æŸ¥çœ‹å·²å ±ååå–®
      </div>
    </div>
  </div>

</div>

<!-- ================== Modals ================== -->

<div class="modal-overlay" id="confirmModal">
  <div class="modal">
    <h3 id="confirmTitle" style="margin-top:0; color: var(--primary); font-size: 24px;">ç¢ºèª</h3>
    <p id="confirmMessage" style="font-size: 17px; font-weight: bold; color: var(--text-main); white-space: pre-wrap; line-height: 1.5; margin: 20px 0;"></p>
    <div style="display: flex; gap: 12px; margin-top: 25px;">
      <button class="btn outline-gray" style="flex:1; font-size: 18px;" onclick="closeConfirmModal()">å–æ¶ˆ</button>
      <button class="btn" id="confirmBtn" style="flex:1; font-size: 18px;" onclick="executeConfirm()">ç¢ºå®š</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="adminPwdModal">
  <div class="modal">
    <h3 style="margin-top:0; color: var(--danger);">ç®¡ç†å“¡é©—è­‰</h3>
    <input type="password" id="adminPwd" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" maxlength="6" inputmode="numeric">
    <div style="display: flex; gap: 10px;">
      <button class="btn outline-gray" style="flex:1;" onclick="closeAllModals()">å–æ¶ˆ</button>
      <button class="btn red" style="flex:1;" onclick="verifyAdmin()">ç¢ºå®š</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="advancedMenuModal">
  <div class="modal modal-large">
    <h3 style="margin-top:0; color: var(--text-main);">âš™ï¸ é€²éšè¨­å®š</h3>
    <div class="adv-grid">
      <button class="btn-adv btn-adv-red" onclick="triggerResetDefaults()"><span style="font-size:28px;">ğŸ—‘ï¸</span>1. å›å¾©é è¨­å€¼</button>
      <button class="btn-adv btn-adv-blue" onclick="openBasicSettings()"><span style="font-size:28px;">ğŸ“</span>2. åŸºæœ¬è¨­å®š</button>
      <button class="btn-adv btn-adv-green" onclick="generateOfficeLeave()"><span style="font-size:28px;">ğŸ«</span>3. å­¸å‹™è™•å…¬å‡å–®</button>
      <button class="btn-adv btn-adv-teal" onclick="generateClassLeave()"><span style="font-size:28px;">ğŸ“‹</span>4. ç­ç´šå…¬å‡å–®</button>
      <button class="btn-adv btn-adv-purple" onclick="window.open('https://drive.google.com/drive/u/0/folders/1LahyXKfZDnOVvJ7Yw-abNJN04hKfLO6a','_blank')"><span style="font-size:28px;">ğŸ“</span>5. é›²ç«¯è³‡æ–™å¤¾</button>
      <button class="btn-adv btn-adv-orange" onclick="openCrossClassModal()"><span style="font-size:28px;">ğŸ¤</span>6. è·¨ç­çµ„éšŠ</button>
      <button class="btn-adv btn-adv-slate" onclick="confirmGroupAssignment()"><span style="font-size:28px;">ğŸ·ï¸</span>7. ç¢ºå®šåˆ†çµ„</button>
      <button class="btn-adv btn-adv-gray"><span style="font-size:24px;">ğŸ”’</span>8. é å‚™åŠŸèƒ½</button>
      <button class="btn-adv btn-adv-gray"><span style="font-size:24px;">ğŸ”’</span>9. é å‚™åŠŸèƒ½</button>
      <button class="btn-adv btn-adv-gray"><span style="font-size:24px;">ğŸ”’</span>10. é å‚™åŠŸèƒ½</button>
    </div>
    <button class="btn outline-gray" style="margin-top:25px; width: 100%; padding: 12px; font-size: 18px;" onclick="closeAllModals()">é—œé–‰é¸å–®</button>
  </div>
</div>

<div class="modal-overlay" id="basicSettingsModal">
  <div class="modal modal-large">
    <h3 style="margin-top:0; color: var(--primary);">ğŸ“ åŸºæœ¬è³‡æ–™è¨­å®š</h3>
    <div class="settings-form" id="settingsFormContainer"></div>
    <div style="display: flex; gap: 10px; margin-top: 20px;">
      <button class="btn outline-gray" style="flex:1;" onclick="document.getElementById('basicSettingsModal').style.display='none'; document.getElementById('advancedMenuModal').style.display='flex';">è¿”å›</button>
      <button class="btn green" style="flex:1;" onclick="saveBasicSettings()">å„²å­˜è¨­å®š</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="crossClassModal">
  <div class="modal modal-large">
    <h3 style="margin-top:0; color: var(--primary);">ğŸŒ è·¨ç­çµ„éšŠ</h3>
    <p style="color: var(--text-muted); font-weight: bold;">è«‹é¸æ“‡ 3 ä½å­¸ç”Ÿçµ„æˆè·¨ç­éšŠä¼ï¼š</p>
    <div id="crossClassMembers" style="margin-top: 20px;">
      <div class="cross-member-row">
        <select id="ccClass1" onchange="fetchCrossStudents(1)"></select>
        <select id="ccStudent1"><option value="">-- å…ˆé¸ç­ç´š --</option></select>
      </div>
      <div class="cross-member-row">
        <select id="ccClass2" onchange="fetchCrossStudents(2)"></select>
        <select id="ccStudent2"><option value="">-- å…ˆé¸ç­ç´š --</option></select>
      </div>
      <div class="cross-member-row">
        <select id="ccClass3" onchange="fetchCrossStudents(3)"></select>
        <select id="ccStudent3"><option value="">-- å…ˆé¸ç­ç´š --</option></select>
      </div>
    </div>
    <div style="display: flex; gap: 10px; margin-top: 25px;">
      <button class="btn outline-gray" style="flex:1;" onclick="document.getElementById('crossClassModal').style.display='none'; document.getElementById('advancedMenuModal').style.display='flex';">è¿”å›</button>
      <button class="btn green" style="flex:1;" onclick="triggerSubmitCrossClassTeam()">é€å‡ºè·¨ç­éšŠä¼</button>
    </div>
  </div>
</div>

<script>
  // ==========================================
  // âš ï¸ éƒ¨ç½²è¨­å®šå€ï¼šè«‹æ›¿æ›ç‚ºæ‚¨çš„ GAS ç¶²é æ‡‰ç”¨ç¨‹å¼ç¶²å€
  // ==========================================
  const GAS_API_URL = "https://script.google.com/macros/s/AKfycbww9F0m7-6g3d9toQ8KVBheIHVAjvstSWAcf2lYUs5vjjQFHay2i_01VjnJ2-snLptk/exec"; 
  
  let sysConfig = {};
  let currentClassStudents = []; 
  let sysClasses = []; 
  
  let confirmCallback = null;
  let adminNextAction = null; 
  let currentEditData = { oldRowIndex: null, classStudents: [], oldGroup: '' };

  // ================== UI è¼”åŠ© ==================
  function showLoader(show) { document.getElementById('loader').style.display = show ? 'flex' : 'none'; }
  function showToast(msg, type='success') {
    const el = document.getElementById('toast');
    el.textContent = msg; el.className = 'toast ' + type + ' show';
    setTimeout(() => el.classList.remove('show'), 3000);
  }
  function closeAllModals() {
    document.querySelectorAll('.modal-overlay').forEach(el => el.style.display = 'none');
    adminNextAction = null;
  }
  function showConfirm(title, message, callback, btnText = 'ç¢ºå®š', btnColor = 'green') {
    document.getElementById('confirmTitle').textContent = title;
    document.getElementById('confirmTitle').style.color = (btnColor === 'red') ? 'var(--danger)' : (btnColor === 'yellow' ? 'var(--warning)' : 'var(--primary)');
    document.getElementById('confirmMessage').textContent = message;
    const btn = document.getElementById('confirmBtn');
    btn.textContent = btnText;
    btn.className = `btn ${btnColor}`;
    confirmCallback = callback;
    document.getElementById('confirmModal').style.display = 'flex';
  }
  function closeConfirmModal() {
    document.getElementById('confirmModal').style.display = 'none';
    confirmCallback = null;
  }
  function executeConfirm() {
    if (confirmCallback) confirmCallback();
    closeConfirmModal();
  }

  // ================== åˆå§‹åŒ–è¼‰å…¥ ==================
  window.onload = () => {
    showLoader(true);
    fetch(`${GAS_API_URL}?action=getInitData&t=${Date.now()}`)
      .then(res => res.json())
      .then(data => {
        if(data.error) throw new Error(data.error);
        
        document.getElementById('pageTitle').innerHTML = `${data.title} <span class="version-text">v2.6</span>`;
        document.title = data.title;
        sysConfig = data; // å­˜å…¥å…¨åŸŸè¨­å®š
        sysClasses = data.classes || [];

        if((data.notices && data.notices.length > 0) || data.imageUrl) {
          document.getElementById('noticeCard').style.display = 'block';
          let contentHtml = '';
          if(data.imageUrl) {
             let imgUrl = data.imageUrl;
             const driveMatch = imgUrl.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
             if(driveMatch && driveMatch[1]) {
                 imgUrl = `https://drive.google.com/uc?export=view&id=${driveMatch[1]}`;
             }
             contentHtml += `<img src="${imgUrl}" class="notice-img" alt="èªªæ˜åœ–ç‰‡" onerror="this.style.display='none'">`;
          }
          if(data.notices) {
             contentHtml += data.notices.map(n => `<p style="margin: 6px 0;">${n}</p>`).join('');
          }
          document.getElementById('noticeContent').innerHTML = contentHtml;
        }

        const select = document.getElementById('classSelect');
        sysClasses.forEach(c => {
          let opt = document.createElement('option');
          opt.value = c; opt.text = c + " ç­";
          select.appendChild(opt);
        });
        
        showLoader(false);
      })
      .catch(err => {
        showLoader(false); showToast("åˆå§‹åŒ–å¤±æ•—: " + err.message, "error");
      });
  };

  // ================== æŸ¥è©¢ç­ç´š ==================
  function queryStudents() {
    const cls = document.getElementById('classSelect').value;
    if(!cls) {
        document.getElementById('statsBar').style.display = 'none';
        document.getElementById('studentListContainer').innerHTML = `<div style="text-align:center; padding: 40px; color:#64748b; font-weight:bold;">ğŸ‘† è«‹å…ˆç”±ä¸Šæ–¹é¸æ“‡ç­ç´šï¼Œæˆ–æŸ¥çœ‹å·²å ±ååå–®</div>`;
        document.getElementById('listTitle').textContent = `åå–®åˆ—è¡¨`;
        return; 
    }

    showLoader(true);
    fetch(`${GAS_API_URL}?action=queryByClass&className=${encodeURIComponent(cls)}&t=${Date.now()}`)
      .then(res => res.json())
      .then(data => {
        showLoader(false);
        if(data.error) throw new Error(data.error);
        
        sysConfig.globalRegCount = data.globalRegCount || 0;
        
        currentClassStudents = data.rows.map(stu => {
            let status = 'none';
            let isCross = false;
            
            if (stu.E == 1 || stu.E == '1') {
                if (sysConfig.regMode === 'å€‹äºº') {
                    status = 'main'; 
                } else {
                    if (stu.F && String(stu.F).includes('è·¨ç­')) {
                        isCross = true;
                        status = 'cross';
                    } else if (stu.F && String(stu.F).includes('æ­£å–')) {
                        status = 'main';
                    } else if (stu.F && String(stu.F).includes('å‚™å–')) {
                        status = 'wait';
                    } else {
                        status = 'main'; 
                    }
                }
            }
            return { ...stu, currentStatus: status, isCross: isCross, origStatus: status };
        });

        sysConfig.classOriginalRegCount = currentClassStudents.filter(s => s.origStatus === 'main' || s.origStatus === 'wait').length;

        document.getElementById('listTitle').textContent = `${cls} ç­ç´šå­¸ç”Ÿåˆ—è¡¨`;
        renderStudentList();
      })
      .catch(err => {
        showLoader(false); showToast("æŸ¥è©¢å¤±æ•—: " + err.message, "error");
      });
  }

  function updateStats() {
      const container = document.getElementById('statsBadgesContainer');
      
      if (sysConfig.regMode === 'å€‹äºº') {
          const currentSelected = currentClassStudents.filter(s => s.currentStatus === 'main').length;
          const netChange = currentSelected - sysConfig.classOriginalRegCount;
          const projectedGlobal = sysConfig.globalRegCount + netChange;
          const limit = sysConfig.individualLimit;
          const remain = Math.max(0, limit - projectedGlobal);
          
          container.innerHTML = `
            <div class="stat-badge main">
              ç›®å‰å ±åï¼š<span class="stat-count" style="color: ${projectedGlobal > limit ? 'red' : 'inherit'}">${projectedGlobal} / ${limit} (å‰© ${remain} äºº)</span>
            </div>
          `;
      } else {
          const mainCount = currentClassStudents.filter(s => s.currentStatus === 'main').length;
          const waitCount = currentClassStudents.filter(s => s.currentStatus === 'wait').length;
          const limitMain = sysConfig.groupSize * sysConfig.mainGroups;
          const limitWait = sysConfig.groupSize * sysConfig.waitlistCount;
          
          container.innerHTML = `
            <div class="stat-badge main">
              æ­£å–ï¼š <span class="stat-count" style="color: ${mainCount > limitMain ? 'red' : 'inherit'}">${mainCount} / ${limitMain}</span>
            </div>
            <div class="stat-badge wait">
              å‚™å–ï¼š <span class="stat-count" style="color: ${waitCount > limitWait ? 'red' : 'inherit'}">${waitCount} / ${limitWait}</span>
            </div>
          `;
      }
      document.getElementById('statsBar').style.display = 'flex';
  }

  function handleStatusChange(rowIndex, newValue) {
      const stu = currentClassStudents.find(s => s.rowIndex === rowIndex);
      
      if (sysConfig.regMode === 'å€‹äºº') {
          if (newValue === 'main') {
              const currentSelected = currentClassStudents.filter(s => s.currentStatus === 'main').length;
              const projectedGlobal = sysConfig.globalRegCount - sysConfig.classOriginalRegCount + currentSelected + 1;
              if (projectedGlobal > sysConfig.individualLimit) {
                  showToast(`è¶…éå ±åä¸Šé™ (${sysConfig.individualLimit}äºº)ï¼`, 'error');
                  renderStudentList(); 
                  return;
              }
          }
      } else {
          if (newValue === 'main') {
              const mainCount = currentClassStudents.filter(s => s.currentStatus === 'main').length;
              const limitMain = sysConfig.groupSize * sysConfig.mainGroups;
              if (mainCount >= limitMain) {
                  showToast(`æ­£å–äººæ•¸å·²é”ä¸Šé™ (${limitMain}äºº)ï¼`, 'error');
                  renderStudentList(); return;
              }
          } else if (newValue === 'wait') {
              const waitCount = currentClassStudents.filter(s => s.currentStatus === 'wait').length;
              const limitWait = sysConfig.groupSize * sysConfig.waitlistCount;
              if (waitCount >= limitWait) {
                  showToast(`å‚™å–äººæ•¸å·²é”ä¸Šé™ (${limitWait}äºº)ï¼`, 'error');
                  renderStudentList(); return;
              }
          }
      }

      stu.currentStatus = newValue;
      renderStudentList(); 
  }

  function renderStudentList() {
    const container = document.getElementById('studentListContainer');
    container.innerHTML = '';
    if(currentClassStudents.length === 0) return;

    currentClassStudents.forEach(stu => {
      const div = document.createElement('div');
      div.className = `stu-card status-${stu.currentStatus}`;

      let rightHtml = '';
      if (stu.isCross) {
          rightHtml = `<span style="color:var(--text-muted); font-weight:900; font-size:16px;">ğŸ”’ ${stu.F}</span>`;
      } else {
          let selClass = 'row-select';
          if(stu.currentStatus === 'main') selClass += ' sel-main';
          if(stu.currentStatus === 'wait') selClass += ' sel-wait';

          let optionsHtml = `<option value="none" ${stu.currentStatus === 'none' ? 'selected' : ''}>ä¸åƒåŠ </option>`;
          if (sysConfig.regMode === 'å€‹äºº') {
              optionsHtml += `<option value="main" ${stu.currentStatus === 'main' ? 'selected' : ''}>åƒåŠ </option>`;
          } else {
              optionsHtml += `<option value="main" ${stu.currentStatus === 'main' ? 'selected' : ''}>æ­£å–</option>`;
              optionsHtml += `<option value="wait" ${stu.currentStatus === 'wait' ? 'selected' : ''}>å‚™å–</option>`;
          }

          rightHtml = `<select class="${selClass}" onchange="handleStatusChange(${stu.rowIndex}, this.value)">${optionsHtml}</select>`;
      }

      div.innerHTML = `
        <div class="stu-info">
          <div class="stu-meta">åº§è™Ÿï¼š${stu.B}</div>
          <div class="stu-name">${stu.C}</div>
        </div>
        <div>${rightHtml}</div>
      `;
      container.appendChild(div);
    });
    updateStats();
  }

  function submitGroup() {
      const payload = [];
      const cls = document.getElementById('classSelect').value;
      if (!cls) return showToast("è«‹å…ˆé¸æ“‡ç­ç´šï¼", "error");

      currentClassStudents.forEach(stu => {
          if (stu.isCross) return; 

          if (sysConfig.regMode === 'å€‹äºº') {
              if (stu.currentStatus === 'main') payload.push({ rowIndex: stu.rowIndex, E: 1, F: `å€‹äºº` });
              else payload.push({ rowIndex: stu.rowIndex, E: 0, F: '' }); 
          } else {
              if (stu.currentStatus === 'main') payload.push({ rowIndex: stu.rowIndex, E: 1, F: `${cls}-æ­£å–` });
              else if (stu.currentStatus === 'wait') payload.push({ rowIndex: stu.rowIndex, E: 1, F: `${cls}-å‚™å–1` });
              else payload.push({ rowIndex: stu.rowIndex, E: 0, F: '' }); 
          }
      });

      if (payload.length === 0) return showToast("æ²’æœ‰è³‡æ–™å¯ä»¥é€å‡ºï¼", "error");

      showConfirm("å„²å­˜ç¢ºèª", "ç¢ºå®šè¦å„²å­˜ç›®å‰çš„å ±åç‹€æ…‹å—ï¼Ÿ\n(åå–®ä¸Šé¡¯ç¤ºä¸åƒåŠ è€…ï¼Œè‹¥åŸå…ˆå·²å ±åå°‡æœƒè¢«å–æ¶ˆ)", () => {
          showLoader(true);
          fetch(GAS_API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            body: JSON.stringify({ action: 'saveGroupSignup', payload: payload })
          })
          .then(res => res.json())
          .then(data => {
            showLoader(false);
            if(data.error) throw new Error(data.error);
            showToast("ğŸ‰ ç­ç´šå ±åå·²æˆåŠŸé€å‡ºï¼");
            queryStudents(); 
          })
          .catch(err => {
            showLoader(false); showToast("å„²å­˜å¤±æ•—: " + err.message, "error");
          });
      }, "ç¢ºå®šé€å‡º", "blue");
  }

  // ================== å…¨æ ¡å·²å ±åæ¸…å–® ==================
  function fetchSignedList() {
    showLoader(true);
    fetch(`${GAS_API_URL}?action=getSignedList&t=${Date.now()}`)
      .then(res => res.json())
      .then(data => {
        showLoader(false);
        if(data.error) throw new Error(data.error);
        
        document.getElementById('statsBar').style.display = 'none'; 
        
        let statsHtml = '';
        if (sysConfig.regMode === 'å€‹äºº') {
            const currentCount = data.rows.length;
            const limit = sysConfig.individualLimit;
            const remain = Math.max(0, limit - currentCount);
            statsHtml = `
              <div style="background:#e0f2fe; color:#0369a1; padding:16px; border-radius:12px; margin-bottom:15px; font-weight:bold; font-size:16px; border:2px solid #bae6fd; box-shadow:0 4px 6px rgba(0,0,0,0.05); text-align:center;">
                ğŸ“Š å ±åçµ±è¨ˆï¼šç›®å‰å…± <span style="color:#0284c7; font-size:22px;">${currentCount}</span> äºº 
                / ä¸Šé™ <span style="color:#e11d48; font-size:22px;">${limit}</span> äºº 
                (å‰©é¤˜ <span style="color:#059669; font-size:22px;">${remain}</span> äºº)
              </div>
            `;
        } else {
            const groupSet = new Set();
            data.rows.forEach(r => { if(r.group) groupSet.add(r.group); });
            const currentGroups = groupSet.size;
            const limitGroups = sysConfig.groupLimit || 20;
            const remainGroups = Math.max(0, limitGroups - currentGroups);
            statsHtml = `
              <div style="background:#e0f2fe; color:#0369a1; padding:16px; border-radius:12px; margin-bottom:15px; font-weight:bold; font-size:16px; border:2px solid #bae6fd; box-shadow:0 4px 6px rgba(0,0,0,0.05); text-align:center;">
                ğŸ“Š å ±åçµ±è¨ˆï¼šç›®å‰å…± <span style="color:#0284c7; font-size:22px;">${currentGroups}</span> çµ„ 
                / ä¸Šé™ <span style="color:#e11d48; font-size:22px;">${limitGroups}</span> çµ„ 
                (å‰©é¤˜ <span style="color:#059669; font-size:22px;">${remainGroups}</span> çµ„)
              </div>
            `;
        }

        if(!data.rows || data.rows.length === 0) {
            document.getElementById('studentListContainer').innerHTML = statsHtml + `<div style="text-align:center; padding: 40px; color:#64748b; font-weight:bold; font-size:18px;">ç›®å‰å…¨æ ¡ç„¡äººå ±å</div>`;
            document.getElementById('listTitle').textContent = "å…¨æ ¡å·²å ±ååå–®";
            return;
        }

        // ================== å¤šå±¤æ¬¡æ’åºæ¼”ç®—æ³• ==================
        data.rows.sort((a, b) => {
            const groupA = String(a.group || '');
            const groupB = String(b.group || '');
            
            const isCrossA = groupA.includes('è·¨ç­');
            const isCrossB = groupB.includes('è·¨ç­');

            // 1. è·¨ç­ä¸€å¾‹æ’åœ¨æœ€å¾Œé¢
            if (isCrossA && !isCrossB) return 1;
            if (!isCrossA && isCrossB) return -1;
            if (isCrossA && isCrossB) {
                const numA = parseInt(groupA.replace(/\D/g, '')) || 0;
                const numB = parseInt(groupB.replace(/\D/g, '')) || 0;
                if (numA !== numB) return numA - numB;
                const classCmp = String(a.className).localeCompare(String(b.className), 'zh-Hant', {numeric: true});
                if (classCmp !== 0) return classCmp;
                return parseInt(a.seatNum || 0) - parseInt(b.seatNum || 0);
            }

            // 2. ä¾æ­£å¼çµ„åˆ¥æ’ (ç¬¬Xçµ„)
            const offA = String(a.officialGroup || '').trim();
            const offB = String(b.officialGroup || '').trim();
            if (offA && !offB) return -1;
            if (!offA && offB) return 1;
            if (offA && offB) {
                const numA = parseInt(offA.replace(/\D/g, '')) || 0;
                const numB = parseInt(offB.replace(/\D/g, '')) || 0;
                if (numA !== numB) return numA - numB;
            }

            // 3. ä¸€èˆ¬ç­ç´šæ’åº
            const classCmp = String(a.className).localeCompare(String(b.className), 'zh-Hant', {numeric: true});
            if (classCmp !== 0) return classCmp;

            // 4. æ­£å–åœ¨å‰ã€å‚™å–åœ¨å¾Œ
            const isMainA = groupA.includes('æ­£å–') || groupA.includes('å€‹äºº');
            const isMainB = groupB.includes('æ­£å–') || groupB.includes('å€‹äºº');
            if (isMainA && !isMainB) return -1;
            if (!isMainA && isMainB) return 1;

            if (!isMainA && !isMainB) {
                const numA = parseInt(groupA.replace(/\D/g, '')) || 0;
                const numB = parseInt(groupB.replace(/\D/g, '')) || 0;
                if (numA !== numB) return numA - numB;
            }

            // 5. åº§è™Ÿæ’åº
            return parseInt(a.seatNum || 0) - parseInt(b.seatNum || 0);
        });

        const thead = `<tr><th>ç­ç´š</th><th>åº§è™Ÿ</th><th>å§“å</th><th>å­¸è™Ÿ</th><th>çµ„åˆ¥</th><th>æ­£å¼çµ„åˆ¥</th><th style="text-align:center;">æ“ä½œ</th></tr>`;
        const tbody = data.rows.map(r => {
            let tagClass = 'gray';
            if (r.officialGroup) {
                tagClass = 'success';
            } else if (r.group.includes('æ­£å–') || r.group.includes('å€‹äºº')) {
                tagClass = 'main';
            } else if (r.group.includes('å‚™å–')) {
                tagClass = 'wait';
            } else if (r.group.includes('è·¨ç­')) {
                tagClass = 'primary';
            }
            
            const officialHtml = r.officialGroup 
                ? `<span class="tag success" style="font-size:16px;">${r.officialGroup}</span>` 
                : `<span class="tag gray" style="background:transparent; color:transparent;">-</span>`;

            return `
            <tr id="signed-row-${r.rowIndex}">
                <td>${r.className}</td>
                <td id="cell-seat-${r.rowIndex}">${r.seatNum}</td>
                <td id="cell-name-${r.rowIndex}">${r.name}</td>
                <td id="cell-stid-${r.rowIndex}">${r.studentId}</td>
                <td><span class="tag ${tagClass}">${r.group}</span></td>
                <td>${officialHtml}</td>
                <td id="cell-action-${r.rowIndex}" style="text-align:center;">
                   <button class="btn yellow" style="padding:6px 12px; font-size:14px; border-radius:8px;" onclick="handleEditSignedBtn(${r.rowIndex}, '${r.className}', '${r.group}')">ä¿®æ”¹</button>
                </td>
            </tr>`;
        }).join('');
        
        document.getElementById('listTitle').textContent = "å…¨æ ¡å·²å ±ååå–®";
        document.getElementById('studentListContainer').innerHTML = `
          ${statsHtml}
          <div style="overflow-x:auto; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); background:white;">
            <table class="vibrant-table">
              <thead>${thead}</thead>
              <tbody>${tbody}</tbody>
            </table>
          </div>
        `;
      })
      .catch(err => {
        showLoader(false); showToast("å–å¾—åå–®å¤±æ•—: " + err.message, "error");
      });
  }

  // ================== ç®¡ç†å“¡èˆ‡æ›¿æ›åŠŸèƒ½ ==================
  function showAdminModal(nextAction = null) {
    adminNextAction = nextAction;
    document.getElementById('adminPwd').value = '';
    document.getElementById('adminPwdModal').style.display = 'flex';
  }

  function verifyAdmin() {
    const pwd = document.getElementById('adminPwd').value;
    if(pwd !== '000000') return showToast("å¯†ç¢¼éŒ¯èª¤", "error");
    
    document.getElementById('adminPwdModal').style.display = 'none';
    
    if (typeof adminNextAction === 'function') {
        adminNextAction(); adminNextAction = null;
    } else {
        document.getElementById('advancedMenuModal').style.display = 'flex';
    }
  }

  function handleEditSignedBtn(rowIndex, className, group) {
      showAdminModal(() => startEditSigned(rowIndex, className, group));
  }

  function startEditSigned(rowIndex, className, oldGroup) {
      showLoader(true);
      fetch(`${GAS_API_URL}?action=queryByClass&className=${encodeURIComponent(className)}&t=${Date.now()}`)
        .then(res => res.json())
        .then(data => {
            showLoader(false);
            if(data.error) throw new Error(data.error);

            currentEditData.oldRowIndex = rowIndex;
            currentEditData.classStudents = data.rows;
            currentEditData.oldGroup = oldGroup;

            const tr = document.getElementById(`signed-row-${rowIndex}`);
            if(!tr) return;

            let seatOptions = '<option value="">è«‹é¸åº§è™Ÿ</option>';
            data.rows.forEach(stu => {
                const isReg = (stu.E == 1 || stu.E == '1');
                if (!isReg || stu.rowIndex === rowIndex) {
                    seatOptions += `<option value="${stu.rowIndex}" ${stu.rowIndex === rowIndex ? 'selected' : ''}>${stu.B}è™Ÿ - ${stu.C}</option>`;
                }
            });

            document.getElementById(`cell-seat-${rowIndex}`).innerHTML = `<select class="main-select" style="padding:4px 8px; min-width:80px; font-size:14px;" onchange="updateEditSelection(${rowIndex}, this.value)">${seatOptions}</select>`;
            document.getElementById(`cell-action-${rowIndex}`).innerHTML = `
              <button class="btn green" style="padding:6px 10px; font-size:14px; border-radius:8px;" onclick="confirmSwapSigned(${rowIndex})">ç¢ºå®š</button>
              <button class="btn outline-gray" style="padding:6px 10px; font-size:14px; border-radius:8px;" onclick="fetchSignedList()">å–æ¶ˆ</button>
            `;
            tr.style.background = 'var(--warning-light)';
        })
        .catch(err => {
            showLoader(false); showToast("è®€å–ç­ç´šåå–®å¤±æ•—: " + err.message, "error");
        });
  }

  function updateEditSelection(oldRowIndex, newRowIndexStr) {
      if(!newRowIndexStr) return;
      const newRowIndex = parseInt(newRowIndexStr);
      const stu = currentEditData.classStudents.find(s => s.rowIndex === newRowIndex);
      if(stu) {
          document.getElementById(`cell-name-${oldRowIndex}`).textContent = stu.C;
          document.getElementById(`cell-stid-${oldRowIndex}`).textContent = stu.D || '';
      }
  }

  function confirmSwapSigned(oldRowIndex) {
      const select = document.querySelector(`#cell-seat-${oldRowIndex} select`);
      if(!select) return;
      const newRowIndex = parseInt(select.value);

      if(!newRowIndex) return showToast('è«‹é¸æ“‡æ›¿æ›å­¸ç”Ÿ', 'error');
      if (newRowIndex === oldRowIndex) { showToast('æœªè®Šæ›´', 'info'); fetchSignedList(); return; }

      const payload = [{rowIndex: oldRowIndex, E: 0, F: ''}, {rowIndex: newRowIndex, E: 1, F: currentEditData.oldGroup}];

      showLoader(true);
      fetch(GAS_API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify({ action: 'saveGroupSignup', payload: payload })
      })
      .then(res => res.json())
      .then(data => {
          showLoader(false);
          if(data.error) throw new Error(data.error);
          showToast('âœ… æ›¿æ›æˆåŠŸï¼');
          fetchSignedList(); 
      })
      .catch(err => { showLoader(false); showToast("å¤±æ•—: " + err.message, "error"); });
  }

  // ================== é€²éšè¨­å®šå€åŸŸ ==================
  function triggerResetDefaults() {
    document.getElementById('advancedMenuModal').style.display = 'none'; 
    showConfirm("âš ï¸ æ¥µåº¦å±éšªæ“ä½œ", "æ¸…é™¤ã€Œæ‰€æœ‰å­¸ç”Ÿã€ç´€éŒ„ç„¡æ³•å¾©åŸï¼Œç¢ºå®šåŸ·è¡Œï¼Ÿ", () => {
        showLoader(true);
        fetch(GAS_API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify({ action: 'resetDefaults' })
        })
        .then(res => res.json())
        .then(data => {
          showLoader(false);
          if(data.error) throw new Error(data.error);
          showToast("å·²æ¢å¾©é è¨­å€¼ï¼");
          document.getElementById('classSelect').value = '';
          document.getElementById('studentListContainer').innerHTML = `<div style="text-align:center; padding: 40px; color:#64748b; font-weight:bold;">è«‹é‡æ–°æŸ¥è©¢ç­ç´š</div>`;
        })
        .catch(err => { showLoader(false); showToast("é‡è¨­å¤±æ•—: " + err.message, "error"); });
    }, "ç¢ºèªæ¸…é™¤å…¨éƒ¨", "red");
  }

  function openBasicSettings() {
    document.getElementById('advancedMenuModal').style.display = 'none';
    showLoader(true);
    fetch(`${GAS_API_URL}?action=getBasicSettings&t=${Date.now()}`, {
      method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify({ action: 'getBasicSettings' })
    })
    .then(res => res.json())
    .then(data => {
      showLoader(false);
      if(data.error) throw new Error(data.error);
      
      const formContainer = document.getElementById('settingsFormContainer');
      formContainer.innerHTML = '';
      
      data.data.forEach((row, idx) => {
          const label = row[0];
          const val = row[1] || '';
          if(!label) return; 
          
          let inputHtml = '';
          if (label.includes('å­¸å¹´åº¦')) {
              inputHtml = `<select class="setting-input">`;
              for(let i=110; i<=130; i++) inputHtml += `<option value="${i}" ${Number(val)===i ? 'selected' : ''}>${i}</option>`;
              inputHtml += `</select>`;
          } else if (label.includes('å­¸æœŸ')) {
              inputHtml = `<select class="setting-input"><option value="1" ${String(val)==='1'?'selected':''}>1</option><option value="2" ${String(val)==='2'?'selected':''}>2</option></select>`;
          } else if (label.includes('å ±åæ–¹å¼')) {
              inputHtml = `<select class="setting-input"><option value="å€‹äºº" ${val==='å€‹äºº'?'selected':''}>å€‹äºº</option><option value="åˆ†çµ„" ${val==='åˆ†çµ„'?'selected':''}>åˆ†çµ„</option></select>`;
          } else if (label.includes('äººæ•¸') || label.includes('çµ„æ•¸') || label.includes('ä¸Šé™')) {
              inputHtml = `<select class="setting-input">`;
              for(let i=1; i<=300; i++) inputHtml += `<option value="${i}" ${Number(val)===i ? 'selected' : ''}>${i}</option>`;
              inputHtml += `</select>`;
          } else {
              inputHtml = `<input type="text" class="setting-input" value="${val}" />`;
          }
          
          const div = document.createElement('div');
          div.innerHTML = `<label>${label}</label>${inputHtml}`;
          formContainer.appendChild(div);
      });
      document.getElementById('basicSettingsModal').style.display = 'flex';
    })
    .catch(err => {
      showLoader(false); showToast("è®€å–å¤±æ•—", "error");
      document.getElementById('advancedMenuModal').style.display = 'flex';
    });
  }

  function saveBasicSettings() {
    const payload = [];
    document.querySelectorAll('#settingsFormContainer .setting-input').forEach((input) => {
        payload.push(input.value.trim());
    });

    showLoader(true);
    fetch(GAS_API_URL, {
      method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify({ action: 'saveBasicSettings', payload: payload })
    })
    .then(res => res.json())
    .then(data => {
      showLoader(false);
      if(data.error) throw new Error(data.error);
      showToast("è¨­å®šå„²å­˜æˆåŠŸï¼Œå³å°‡é‡æ–°è¼‰å…¥ï¼");
      setTimeout(() => window.location.reload(), 1500);
    })
    .catch(err => { showLoader(false); showToast("å„²å­˜å¤±æ•—", "error"); });
  }

  // ================== å…¬å‡å–®ã€è·¨ç­èˆ‡ç¢ºå®šåˆ†çµ„ ==================
  function generateOfficeLeave() {
      document.getElementById('advancedMenuModal').style.display = 'none';
      showConfirm("å…¬å‡å–®ç¢ºèª", "ç”¢ç”Ÿã€Œå­¸å‹™è™•å…¬å‡å–®ã€PDF + Excel å—ï¼Ÿ", () => {
          showLoader(true);
          fetch(GAS_API_URL, { method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify({ action: 'generateOfficeLeave' }) })
          .then(res => res.json())
          .then(data => { showLoader(false); if(data.error||!data.ok) throw new Error(data.message||'å¤±æ•—'); showToast("âœ… å·²ç”¢ç”Ÿè‡³é›²ç«¯ï¼"); })
          .catch(err => { showLoader(false); showToast(err.message, "error"); });
      }, "ç¢ºå®šç”¢ç”Ÿ", "blue");
  }

  function generateClassLeave() {
      document.getElementById('advancedMenuModal').style.display = 'none';
      showConfirm("å…¬å‡å–®ç¢ºèª", "åˆä½µç”¢ç”Ÿã€Œç­ç´šå…¬å‡å–®ã€PDF å—ï¼Ÿ", () => {
          showLoader(true);
          fetch(GAS_API_URL, { method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify({ action: 'generateClassLeave' }) })
          .then(res => res.json())
          .then(data => { showLoader(false); if(data.error||!data.ok) throw new Error(data.message||'å¤±æ•—'); showToast(`âœ… å·²åˆä½µï¼ˆå…± ${data.count} ç­ï¼‰`); })
          .catch(err => { showLoader(false); showToast(err.message, "error"); });
      }, "ç¢ºå®šåˆä½µ", "blue");
  }

  function confirmGroupAssignment() {
      document.getElementById('advancedMenuModal').style.display = 'none';
      showConfirm("ç¢ºå®šåˆ†çµ„", "ç¢ºå®šè¦åŸ·è¡Œè‡ªå‹•åˆ†çµ„å—ï¼Ÿ\nç³»çµ±å°‡æœƒæ¸…ç©ºã€ŒåƒåŠ åå–®ã€ç›®å‰çš„æ­£å¼çµ„åˆ¥ï¼Œä¸¦ä¾æ“šç¾æœ‰çµ„åˆ¥ä¾åºç·¨è™Ÿï¼ˆç¬¬1çµ„ã€ç¬¬2çµ„...ï¼‰ã€‚", () => {
          showLoader(true);
          fetch(GAS_API_URL, {
              method: 'POST',
              headers: { 'Content-Type': 'text/plain;charset=utf-8' },
              body: JSON.stringify({ action: 'confirmGroups' })
          })
          .then(res => res.json())
          .then(data => {
              showLoader(false);
              if(data.error) throw new Error(data.error);
              showToast(`âœ… åˆ†çµ„æˆåŠŸï¼å…±ç”¢ç”Ÿ ${data.count} çµ„ã€‚`);
              fetchSignedList(); 
          })
          .catch(err => {
              showLoader(false);
              showToast("åˆ†çµ„å¤±æ•—: " + err.message, "error");
          });
      }, "åŸ·è¡Œåˆ†çµ„", "blue");
  }

  function openCrossClassModal() {
    document.getElementById('advancedMenuModal').style.display = 'none';
    [1, 2, 3].forEach(num => {
        const clsSel = document.getElementById(`ccClass${num}`);
        clsSel.innerHTML = '<option value="">-- é¸æ“‡ç­ç´š --</option>';
        sysClasses.forEach(c => { clsSel.innerHTML += `<option value="${c}">${c} ç­</option>`; });
        document.getElementById(`ccStudent${num}`).innerHTML = '<option value="">-- å…ˆé¸ç­ç´š --</option>';
    });
    document.getElementById('crossClassModal').style.display = 'flex';
  }

  function fetchCrossStudents(num) {
    const cls = document.getElementById(`ccClass${num}`).value;
    const stuSel = document.getElementById(`ccStudent${num}`);
    if(!cls) { stuSel.innerHTML = '<option value="">-- å…ˆé¸ç­ç´š --</option>'; return; }
    
    stuSel.innerHTML = '<option value="">è¼‰å…¥ä¸­...</option>';
    fetch(`${GAS_API_URL}?action=queryByClass&className=${encodeURIComponent(cls)}&t=${Date.now()}`)
      .then(res => res.json())
      .then(data => {
          stuSel.innerHTML = '<option value="">-- é¸æ“‡å­¸ç”Ÿ --</option>';
          data.rows.forEach(stu => {
              const isReg = (stu.E == 1 || stu.E == '1');
              const mark = isReg ? ' (å·²å ±å)' : '';
              stuSel.innerHTML += `<option value="${stu.rowIndex}" ${isReg ? 'disabled' : ''}>${stu.B}è™Ÿ - ${stu.C}${mark}</option>`;
          });
      });
  }

  function triggerSubmitCrossClassTeam() {
    const s1 = document.getElementById('ccStudent1').value;
    const s2 = document.getElementById('ccStudent2').value;
    const s3 = document.getElementById('ccStudent3').value;
    if(!s1 || !s2 || !s3) return showToast("è«‹é¸æ»¿3äººï¼", "error");
    if(new Set([s1, s2, s3]).size !== 3) return showToast("ä¸å¯é‡è¤‡ï¼", "error");

    document.getElementById('crossClassModal').style.display = 'none';
    showConfirm("è·¨ç­çµ„éšŠ", "ç¢ºå®šçµ„æˆè·¨ç­éšŠä¼å—ï¼Ÿ", () => {
        showLoader(true);
        fetch(GAS_API_URL, {
            method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            body: JSON.stringify({ action: 'saveCrossClassTeam', payload: [Number(s1), Number(s2), Number(s3)] })
        })
        .then(res => res.json())
        .then(data => {
            showLoader(false);
            showToast(`ğŸ‰ æˆåŠŸï¼çµ„åˆ¥ï¼š${data.newTeam}`);
            closeAllModals();
            if(document.getElementById('classSelect').value) queryStudents(); 
        });
    }, "ç¢ºå®šçµ„éšŠ", "blue");
  }
</script>
</body>
</html>