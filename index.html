<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>çµ„éšŠå ±åç³»çµ±</title>
<style>
  :root {
    /* æ›´é®®è±”ã€ç¾ä»£çš„ APP é…è‰² */
    --primary: #2563eb;       /* ä¸»è‰²ï¼šé®®è±”è— */
    --primary-light: #dbeafe; 
    --success: #059669;       /* æˆåŠŸ/æ­£å–ï¼šç¿ ç¶ è‰² */
    --danger: #e11d48;        /* å±éšª/ç§»é™¤ï¼šç«ç‘°ç´… */
    --warning: #d97706;       /* å‚™å–ï¼šç¥ç€æ©˜ */
    --info: #0ea5e9;          /* è³‡è¨Šï¼šå¤©è—è‰² */
    --bg-page: #f1f5f9;       /* é é¢èƒŒæ™¯ï¼šæ·ºç°è— */
    --card-bg: #ffffff;
    --text-main: #0f172a;
    --text-muted: #64748b;
    --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
    --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
    --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
  }

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  
  html, body { height: 100%; margin: 0; }
  body {
    background: var(--bg-page); color: var(--text-main);
    font-family: system-ui, -apple-system, "Noto Sans TC", sans-serif;
    padding-bottom: 80px; /* é ç•™çµ¦æ‰‹æ©Ÿç‰ˆç½®åº•åˆ—çš„ç©ºé–“ */
  }
  
  .wrap { max-width: 1200px; margin: 20px auto; padding: 0 16px; }

  /* é ‚éƒ¨æ¨™é¡Œ - æ¼¸å±¤é®®è±”è‰²å½© */
  .header-title {
    font-size: 32px; font-weight: 900; text-align: center; margin-bottom: 20px;
    background: linear-gradient(135deg, #1e3a8a, #3b82f6); color: #fff;
    padding: 20px; border-radius: 16px; box-shadow: var(--shadow-md);
    letter-spacing: 2px;
  }

  /* æç¤ºè¨Šæ¯ */
  .toast {
    position: fixed; left: 50%; top: 20px; transform: translateX(-50%);
    color: #fff; padding: 14px 28px; border-radius: 999px; box-shadow: var(--shadow-lg);
    z-index: 1100; display: none; font-weight: 800; font-size: 16px; white-space: nowrap;
  }
  .toast.show { display: block; animation: popDown 0.3s ease forwards; }
  @keyframes popDown { from { top: -20px; opacity: 0; } to { top: 20px; opacity: 1; } }
  .toast.success { background: var(--success); }
  .toast.error { background: var(--danger); }
  .toast.info { background: var(--info); }

  /* è¼‰å…¥ä¸­ */
  #loader {
    position: fixed; inset: 0; background: rgba(255,255,255,0.85); z-index: 1000;
    display: flex; justify-content: center; align-items: center; flex-direction: column;
  }
  .spinner {
    width: 50px; height: 50px; border: 5px solid var(--primary-light);
    border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* ç‰ˆé¢é…ç½® */
  .layout { display: flex; gap: 24px; flex-wrap: wrap; }
  .col-left { flex: 3; min-width: 320px; }
  .col-right { flex: 2; min-width: 320px; }

  .card {
    background: var(--card-bg); border-radius: 16px;
    padding: 20px; box-shadow: var(--shadow-md); margin-bottom: 20px;
  }

  /* æŒ‰éˆ•èˆ‡æ§åˆ¶åˆ— */
  .controls { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; margin-bottom: 20px; }
  select { 
    padding: 12px 16px; border-radius: 12px; border: 2px solid #cbd5e1; 
    font-size: 16px; min-width: 160px; font-weight: bold; outline: none;
  }
  select:focus { border-color: var(--primary); }
  
  .btn { 
    padding: 12px 20px; border: none; border-radius: 999px; color: #fff; 
    font-size: 16px; cursor: pointer; font-weight: 800; transition: all 0.2s;
    display: inline-flex; align-items: center; justify-content: center;
  }
  .btn:active { transform: scale(0.95); }
  .btn.blue { background: var(--primary); }
  .btn.green { background: var(--success); }
  .btn.red { background: var(--danger); }
  .btn.yellow { background: var(--warning); color: #fff; }
  .btn.pink { background: #db2777; }
  .btn.outline { background: transparent; border: 2px solid var(--danger); color: var(--danger); }

  /* ===== APP é¢¨æ ¼çš„å­¸ç”Ÿåå–® (å–ä»£åŸæœ¬çš„è¡¨æ ¼) ===== */
  .stu-list { display: flex; flex-direction: column; gap: 12px; margin-top: 10px; }
  
  .stu-card {
    display: flex; align-items: center; justify-content: space-between;
    padding: 16px; background: var(--card-bg); border-radius: 16px;
    box-shadow: var(--shadow-sm); border: 2px solid #e2e8f0;
    cursor: pointer; transition: 0.2s;
  }
  .stu-card:active { background: #f8fafc; transform: scale(0.99); }
  .stu-card.selected { border-color: var(--primary); background: var(--primary-light); }
  .stu-card.signed { background: #f8fafc; border-color: #cbd5e1; cursor: default; }
  
  .stu-info { display: flex; flex-direction: column; gap: 4px; }
  .stu-meta { font-size: 14px; color: var(--text-muted); font-weight: bold; }
  .stu-name { font-size: 20px; font-weight: 900; color: var(--text-main); }
  
  .stu-status-area { display: flex; align-items: center; gap: 12px; }
  .status-text { font-size: 15px; font-weight: 800; }
  
  .action-btn {
    padding: 8px 16px; border-radius: 999px; border: none; color: white;
    font-size: 14px; font-weight: bold; cursor: pointer;
  }
  .action-btn.add { background: var(--primary); }
  .action-btn.remove { background: var(--danger); }
  
  /* æ›¿æ›æ¨¡å¼è·³å‹•æŒ‰éˆ•å‹•ç•« */
  @keyframes pulse-btn {
      0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(5, 150, 105, 0.7); }
      50% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(5, 150, 105, 0); }
      100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(5, 150, 105, 0); }
  }
  .pulse-btn { animation: pulse-btn 2s infinite; }

  /* å¾…æäº¤æ¸…å–® (å³å´) */
  .group-info { 
    background: #e0e7ff; color: #3730a3; padding: 12px; border-radius: 12px; 
    margin-bottom: 15px; font-weight: 900; font-size: 16px; border: 1px dashed #818cf8;
  }
  .selected-list { min-height: 150px; }
  
  .selected-item {
    background: var(--card-bg); border-left: 6px solid var(--primary);
    border-radius: 12px; padding: 16px; margin-bottom: 12px;
    display: flex; justify-content: space-between; align-items: center;
    box-shadow: var(--shadow-sm); border-top: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0; border-bottom: 1px solid #e2e8f0;
  }
  
  .tag { border-radius: 8px; font-size: 14px; font-weight: 900; padding: 6px 12px; color: white; letter-spacing: 1px;}
  .tag.main { background: var(--success); }
  .tag.wait { background: var(--warning); }
  
  .remove-btn-small { 
    background: #fee2e2; color: var(--danger); border: none; border-radius: 8px; 
    padding: 6px 12px; cursor: pointer; font-size: 14px; font-weight: 900;
  }

  /* å·²å ±ååå–®è¡¨æ ¼å°ˆç”¨ (é®®è±”æ¨£å¼) */
  .vibrant-table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 500px; }
  .vibrant-table th { background: var(--primary); color: white; padding: 16px; text-align: left; font-size: 16px;}
  .vibrant-table td { padding: 16px; background: white; border-bottom: 1px solid #e2e8f0; font-size: 16px; font-weight: bold;}
  .vibrant-table tr:hover td { background: #f8fafc; }
  .vibrant-table th:first-child { border-top-left-radius: 12px; }
  .vibrant-table th:last-child { border-top-right-radius: 12px; }

  /* ===== æ‰‹æ©Ÿç‰ˆå°ˆå±¬ï¼šç½®åº•æ“ä½œåˆ— ===== */
  .mobile-bottom-bar {
    display: none; position: fixed; bottom: 0; left: 0; width: 100%;
    background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
    box-shadow: 0 -4px 15px rgba(0,0,0,0.1); padding: 12px 20px; 
    align-items: center; justify-content: space-between; z-index: 900;
    border-top: 1px solid #e2e8f0;
  }
  
  /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
  @media (max-width: 768px) {
    .col-main { order: 2; } /* æ‰‹æ©Ÿç‰ˆï¼šå­¸ç”Ÿåå–®åœ¨ä¸‹æ–¹ */
    .col-side { order: 1; } /* æ‰‹æ©Ÿç‰ˆï¼šå·²é¸éšŠä¼åœ¨ä¸Šæ–¹ */
    .mobile-bottom-bar { display: flex; } /* é¡¯ç¤ºæ‰‹æ©Ÿç½®åº•åˆ— */
    .desktop-submit-area { display: none; } /* éš±è—æ¡Œæ©Ÿç‰ˆæŒ‰éˆ•å€ */
    body { padding-bottom: 90px; }
    
    .header-title { font-size: 24px; padding: 15px; }
    .stu-card { padding: 12px; }
    .stu-name { font-size: 18px; }
    .controls { flex-direction: column; align-items: stretch; }
  }

  /* å¯†ç¢¼è¦–çª— */
  .modal-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);
    display: none; justify-content: center; align-items: center; z-index: 1200;
  }
  .modal { background: #fff; padding: 30px; border-radius: 20px; width: 320px; text-align: center; box-shadow: var(--shadow-lg);}
  .modal input { width: 100%; padding: 14px; margin: 20px 0; border: 2px solid #cbd5e1; border-radius: 12px; text-align:center; font-size: 20px; font-weight: bold;}
  .modal input:focus { border-color: var(--primary); outline: none; }
</style>
</head>
<body>

<div id="loader">
  <div class="spinner"></div>
  <div style="margin-top: 15px; font-weight: bold; color: var(--primary); font-size: 18px;">ç³»çµ±è¼‰å…¥ä¸­...</div>
</div>
<div id="toast" class="toast"></div>

<div class="wrap layout">
  
  <!-- å·¦å´ï¼šæŒ‘é¸å­¸ç”Ÿ -->
  <div class="col-left col-main">
    <div class="header-title" id="pageTitle">çµ„éšŠå ±åç³»çµ±</div>

    <div class="card" id="noticeCard" style="background:#ecfdf5; border:2px solid #a7f3d0; display:none;">
      <h3 style="margin-top:0; color:var(--success);">ğŸ“Œ å ±åèªªæ˜</h3>
      <div id="noticeContent" style="font-weight: bold; line-height: 1.6;"></div>
    </div>

    <div class="card">
      <div class="controls">
        <select id="classSelect"><option value="">-- è«‹é¸æ“‡ç­ç´š --</option></select>
        <button class="btn blue" onclick="queryStudents()">ğŸ” æŸ¥è©¢åå–®</button>
        <button class="btn yellow" onclick="fetchSignedList()">ğŸ“„ å·²å ±ååå–®</button>
        <button class="btn outline" onclick="showAdminModal()">âš™ï¸ è¨­å®š</button>
      </div>
      
      <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:3px solid var(--primary); padding-bottom:10px; margin-top: 25px;">
        <h3 id="listTitle" style="margin:0; color:var(--primary); font-size: 22px;">ç­ç´šå­¸ç”Ÿåˆ—è¡¨</h3>
      </div>
      
      <!-- å¡ç‰‡å¼å­¸ç”Ÿæ¸…å–®å®¹å™¨ -->
      <div id="studentListContainer" class="stu-list">
        <div style="text-align:center; padding: 40px 20px; color: var(--text-muted); font-weight: bold; font-size: 18px; background: #f8fafc; border-radius: 16px; border: 2px dashed #cbd5e1;">
          ğŸ‘† è«‹å…ˆç”±ä¸Šæ–¹é¸æ“‡ç­ç´šä¸¦é»æ“ŠæŸ¥è©¢
        </div>
      </div>
    </div>
  </div>

  <!-- å³å´ï¼šå¾…æäº¤çµ„éšŠåå–® -->
  <div class="col-right col-side">
    <div class="card" style="border: 3px solid var(--primary); position: sticky; top: 20px;">
      <h3 style="margin-top:0; color:var(--primary); font-size: 22px; display: flex; align-items: center; gap: 8px;">
        ğŸ“ ç›®å‰çµ„éšŠç‹€æ…‹
      </h3>
      
      <div class="group-info" id="groupRuleInfo">
        è¨­å®šï¼š1çµ„3 äººï¼Œæ­£å–1çµ„ã€å‚™å–1 çµ„
      </div>

      <div class="selected-list" id="selectedListContainer">
         <div style="text-align:center; color:var(--text-muted); margin-top:40px; font-weight: bold;">
           å°šç„¡é¸å–å­¸ç”Ÿ<br>è«‹å¾å·¦å´é»æ“ŠåŠ å…¥
         </div>
      </div>

      <!-- æ¡Œæ©Ÿç‰ˆæŒ‰éˆ•å€ -->
      <div class="desktop-submit-area" style="margin-top: 25px; display: flex; gap: 12px;">
        <button class="btn green" style="flex:2; font-size: 18px;" onclick="submitGroup()">ğŸš€ é€å‡ºå ±å</button>
        <button class="btn outline" style="flex:1;" onclick="clearSelected()">æ¸…ç©º</button>
      </div>
    </div>
  </div>
</div>

<!-- æ‰‹æ©Ÿç‰ˆå°ˆå±¬ï¼šç½®åº•æ“ä½œåˆ— -->
<div class="mobile-bottom-bar">
  <div style="display: flex; flex-direction: column;">
    <span style="font-size: 14px; color: var(--text-muted); font-weight: bold;">ç›®å‰å·²é¸å–</span>
    <span style="font-size: 20px; font-weight: 900; color: var(--primary);">
      <span id="mobileSelectedCount">0</span> äºº
    </span>
  </div>
  <div style="display: flex; gap: 10px;">
    <button class="btn outline" style="padding: 10px 15px;" onclick="clearSelected()">æ¸…ç©º</button>
    <button class="btn green" style="padding: 12px 24px; font-size: 18px;" onclick="submitGroup()">é€å‡º</button>
  </div>
</div>

<!-- ç®¡ç†å“¡å¯†ç¢¼è¦–çª— -->
<div class="modal-overlay" id="adminModal">
  <div class="modal">
    <h3 style="margin-top:0; color: var(--danger);">ç®¡ç†å“¡é©—è­‰</h3>
    <p style="color: var(--text-muted); font-size: 14px; margin:0;">é‡è¨­è³‡æ–™å°ˆç”¨</p>
    <input type="password" id="adminPwd" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" maxlength="6" inputmode="numeric">
    <div style="display: flex; gap: 10px; margin-top: 10px;">
      <button class="btn outline" style="flex:1;" onclick="document.getElementById('adminModal').style.display='none'">å–æ¶ˆ</button>
      <button class="btn red" style="flex:1;" onclick="verifyAdmin()">ç¢ºå®š</button>
    </div>
  </div>
</div>

<script>
  // ==========================================
  // âš ï¸ éƒ¨ç½²è¨­å®šå€ï¼šè«‹æ›¿æ›ç‚ºæ‚¨çš„ GAS ç¶²é æ‡‰ç”¨ç¨‹å¼ç¶²å€
  // ==========================================
  const GAS_API_URL = "https://script.google.com/macros/s/AKfycbww9F0m7-6g3d9toQ8KVBheIHVAjvstSWAcf2lYUs5vjjQFHay2i_01VjnJ2-snLptk/exec"; 
  
  // ç³»çµ±å…¨åŸŸè®Šæ•¸
  let sysConfig = { groupSize: 3, waitlistCount: 1 };
  let currentClassStudents = []; 
  let selectedTeam = []; 
  let replacingStudent = null; // è¨˜éŒ„ç›®å‰æ­£åœ¨è¢«æ›¿æ›çš„å­¸ç”Ÿ

  // ================== UI è¼”åŠ©å‡½å¼ ==================
  function showLoader(show) { document.getElementById('loader').style.display = show ? 'flex' : 'none'; }
  function showToast(msg, type='success') {
    const el = document.getElementById('toast');
    el.textContent = msg; el.className = 'toast ' + type + ' show';
    setTimeout(() => el.classList.remove('show'), 3000);
  }

  // ================== åˆå§‹åŒ–è¼‰å…¥ ==================
  window.onload = () => {
    showLoader(true);
    fetch(`${GAS_API_URL}?action=getInitData`)
      .then(res => res.json())
      .then(data => {
        if(data.error) throw new Error(data.error);
        
        document.getElementById('pageTitle').textContent = data.title;
        document.title = data.title;
        
        sysConfig.groupSize = data.groupSize || 3;
        sysConfig.waitlistCount = data.waitlistCount || 1;
        updateGroupRuleText();

        if(data.notices && data.notices.length > 0) {
          document.getElementById('noticeCard').style.display = 'block';
          document.getElementById('noticeContent').innerHTML = data.notices.map(n => `<p style="margin: 6px 0;">${n}</p>`).join('');
        }

        const select = document.getElementById('classSelect');
        data.classes.forEach(c => {
          let opt = document.createElement('option');
          opt.value = c; opt.text = c + " ç­";
          select.appendChild(opt);
        });
        
        showLoader(false);
      })
      .catch(err => {
        showLoader(false);
        showToast("åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹ç¢ºèª GAS ç¶²å€: " + err.message, "error");
      });
  };

  function updateGroupRuleText() {
    document.getElementById('groupRuleInfo').textContent = 
      `ğŸ“Œ è¨­å®šï¼š1çµ„${sysConfig.groupSize}äººï¼Œæ­£å–1çµ„ã€å‚™å–${sysConfig.waitlistCount}çµ„`;
  }

  // ================== æŸ¥è©¢ç­ç´šå­¸ç”Ÿ ==================
  function queryStudents() {
    const cls = document.getElementById('classSelect').value;
    if(!cls) return showToast("è«‹å…ˆé¸æ“‡ç­ç´š", "error");

    showLoader(true);
    fetch(`${GAS_API_URL}?action=queryByClass&className=${encodeURIComponent(cls)}`)
      .then(res => res.json())
      .then(data => {
        showLoader(false);
        if(data.error) throw new Error(data.error);
        
        currentClassStudents = data.rows;
        replacingStudent = null; // æŸ¥è©¢æ–°ç­ç´šæ™‚é‡ç½®æ›¿æ›æ¨¡å¼
        document.getElementById('listTitle').textContent = `${cls} ç­ç´šå­¸ç”Ÿåˆ—è¡¨`;
        renderStudentList();
      })
      .catch(err => {
        showLoader(false); showToast("æŸ¥è©¢å¤±æ•—: " + err.message, "error");
      });
  }

  // æ¸²æŸ“ç‚º APP é¢¨æ ¼å¡ç‰‡
  function renderStudentList() {
    const container = document.getElementById('studentListContainer');
    container.innerHTML = '';
    
    if(currentClassStudents.length === 0) {
      container.innerHTML = `<div style="text-align:center; padding: 40px; color:#64748b; font-weight:bold;">æ­¤ç­ç´šæŸ¥ç„¡å­¸ç”Ÿè³‡æ–™</div>`;
      return;
    }

    // è‹¥è™•æ–¼ã€Œæ›¿æ›æ¨¡å¼ã€ï¼Œé¡¯ç¤ºé ‚éƒ¨æç¤º Banner
    if (replacingStudent) {
      const banner = document.createElement('div');
      banner.style.padding = '12px 16px';
      banner.style.background = '#fef08a';
      banner.style.color = '#854d0e';
      banner.style.borderRadius = '12px';
      banner.style.marginBottom = '12px';
      banner.style.fontWeight = 'bold';
      banner.style.display = 'flex';
      banner.style.justifyContent = 'space-between';
      banner.style.alignItems = 'center';
      banner.innerHTML = `
          <span>ğŸ”„ æ­£åœ¨æ›¿æ›ã€Œ${replacingStudent.C}ã€... è«‹é»é¸ä¸‹æ–¹æœªå ±åå­¸ç”Ÿ</span>
          <button class="action-btn remove" onclick="cancelReplaceMode(event)">å–æ¶ˆæ›¿æ›</button>
      `;
      container.appendChild(banner);
    }

    currentClassStudents.forEach(stu => {
      const isSelected = selectedTeam.some(s => s.rowIndex === stu.rowIndex);
      const isAlreadySigned = stu.E == 1 || stu.E == '1';

      let cardClass = 'stu-card';
      if (isSelected) cardClass += ' selected';
      else if (isAlreadySigned) cardClass += ' signed'; 

      let statusHtml = '';
      if (isSelected) statusHtml = '<span class="status-text" style="color:var(--primary);">ğŸ”µ å·²é¸å–</span>';
      else if (isAlreadySigned) statusHtml = `<span class="status-text" style="color:var(--danger);">ğŸ”’ ${stu.F || 'å·²å ±å'}</span>`;
      else statusHtml = '<span class="status-text" style="color:var(--text-muted);">âšª æœªå ±å</span>';

      let btnHtml = '';
      if (isAlreadySigned && !isSelected) {
        // é‡å°å·²å ±åå­¸ç”Ÿï¼Œé¡¯ç¤ºã€Œæ›¿æ›ã€èˆ‡ã€Œå–æ¶ˆã€æŒ‰éˆ•
        btnHtml = `
          <div style="display:flex; gap:8px;">
            <button class="action-btn" style="background:var(--warning); color:#fff;" onclick="startReplace(${stu.rowIndex}, event)">æ›¿æ›</button>
            <button class="action-btn remove" onclick="cancelSignup(${stu.rowIndex}, event)">å–æ¶ˆ</button>
          </div>`;
      } else {
        if (replacingStudent && !isAlreadySigned && !isSelected) {
            // åœ¨æ›¿æ›æ¨¡å¼ä¸­ï¼Œæœªå ±åçš„å­¸ç”Ÿé¡¯ç¤ºé–ƒçˆçš„æ›¿æ›ç›®æ¨™æŒ‰éˆ•
            btnHtml = `<button class="action-btn add pulse-btn" style="background:var(--success);" onclick="executeReplace(${stu.rowIndex}, event)">é¸ç‚ºæ›¿æ›</button>`;
        } else {
            // æ­£å¸¸çš„åŠ /æ¸›æŒ‰éˆ•
            btnHtml = `<button class="action-btn ${isSelected ? 'remove' : 'add'}" onclick="toggleSelect(${stu.rowIndex}, event)">
                         ${isSelected ? 'ç§»é™¤' : 'åŠ å…¥ +'}
                       </button>`;
        }
      }

      const div = document.createElement('div');
      div.className = cardClass;
      
      // å¡ç‰‡æ•´é«”é»æ“Šäº‹ä»¶è™•ç†
      div.onclick = (e) => { 
        if (isAlreadySigned && !isSelected) {
          // å·²ç¶“å ±åçš„ç‹€æ…‹ï¼Œå¡ç‰‡æœ¬é«”é»æ“Šä¸å‹•ä½œï¼Œäº¤çµ¦è£¡é¢çš„æŒ‰éˆ•è§¸ç™¼
        } else if (replacingStudent && !isAlreadySigned && !isSelected) {
          executeReplace(stu.rowIndex, e);
        } else {
          toggleSelect(stu.rowIndex, e); 
        }
      };
      
      div.innerHTML = `
        <div class="stu-info">
          <div class="stu-meta">åº§è™Ÿï¼š${stu.B}</div>
          <div class="stu-name">${stu.C}</div>
        </div>
        <div class="stu-status-area">
          ${statusHtml}
          ${btnHtml}
        </div>
      `;
      container.appendChild(div);
    });
  }

  // ================== å–®ä¸€å ±åæ“ä½œ (å–æ¶ˆ/æ›¿æ›) ==================

  // 1. é–‹å§‹æ›¿æ›æ¨¡å¼
  function startReplace(rowIndex, event) {
    if(event) event.stopPropagation();
    replacingStudent = currentClassStudents.find(s => s.rowIndex === rowIndex);
    showToast(`è«‹é»é¸è¦æ›¿æ›çš„æ–°å­¸ç”Ÿ`, 'info');
    renderStudentList();
  }

  // å–æ¶ˆæ›¿æ›æ¨¡å¼
  function cancelReplaceMode(event) {
    if(event) event.stopPropagation();
    replacingStudent = null;
    renderStudentList();
  }

  // 2. åŸ·è¡Œæ›¿æ›
  function executeReplace(newRowIndex, event) {
    if(event) event.stopPropagation();
    const newStu = currentClassStudents.find(s => s.rowIndex === newRowIndex);
    
    if(confirm(`ç¢ºå®šè¦å°‡ã€Œ${replacingStudent.C}ã€æ›¿æ›ç‚ºã€Œ${newStu.C}ã€å—ï¼Ÿ\n(æ–°å­¸ç”Ÿå°‡ç¹¼æ‰¿åŸçµ„åˆ¥ï¼š${replacingStudent.F})`)) {
      // å‚³é€ï¼šå°‡èˆŠå­¸ç”Ÿ E è¨­ç‚º 0, F æ¸…ç©ºï¼›å°‡æ–°å­¸ç”Ÿ E è¨­ç‚º 1, F ç¹¼æ‰¿
      const payload = [
        { rowIndex: replacingStudent.rowIndex, E: 0, F: '' },
        { rowIndex: newStu.rowIndex, E: 1, F: replacingStudent.F || '' }
      ];
      quickSave(payload, "âœ… æ›¿æ›æˆåŠŸï¼");
      replacingStudent = null;
    }
  }

  // 3. å–æ¶ˆå ±å
  function cancelSignup(rowIndex, event) {
    if(event) event.stopPropagation();
    const stu = currentClassStudents.find(s => s.rowIndex === rowIndex);
    
    if(confirm(`ç¢ºå®šè¦å–æ¶ˆã€Œ${stu.C}ã€çš„å ±åå—ï¼Ÿ\n(å°‡æ¸…ç©ºå…¶åƒåŠ ç‹€æ…‹èˆ‡çµ„åˆ¥ç´€éŒ„)`)) {
      // å‚³é€ï¼šå°‡å­¸ç”Ÿ E è¨­ç‚º 0, F æ¸…ç©º
      const payload = [{ rowIndex: stu.rowIndex, E: 0, F: '' }];
      quickSave(payload, "ğŸ—‘ï¸ å·²å–æ¶ˆå ±åï¼");
    }
  }

  // å…±ç”¨çš„å¿«é€Ÿå¯«å…¥å¾Œç«¯å‡½å¼ (é‡å°å–æ¶ˆèˆ‡æ›¿æ›)
  function quickSave(payload, successMsg) {
    showLoader(true);
    fetch(GAS_API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify({ action: 'saveGroupSignup', payload: payload })
    })
    .then(res => res.json())
    .then(data => {
      showLoader(false);
      if(data.error) throw new Error(data.error);
      showToast(successMsg);
      // é‡æ–°åˆ·æ–°å·¦å´æ¸…å–®ä»¥é¡¯ç¤ºæœ€æ–°è³‡æ–™
      queryStudents(); 
    })
    .catch(err => {
      showLoader(false);
      showToast("æ“ä½œå¤±æ•—: " + err.message, "error");
    });
  }

  // ================== å¤šäººçµ„éšŠé¸å–é‚è¼¯ ==================
  function toggleSelect(rowIndex, event) {
    if(event) event.stopPropagation(); 
    
    const stuIdx = currentClassStudents.findIndex(s => s.rowIndex === rowIndex);
    const stu = currentClassStudents[stuIdx];
    
    const existingIdx = selectedTeam.findIndex(s => s.rowIndex === rowIndex);
    if (existingIdx > -1) {
      selectedTeam.splice(existingIdx, 1);
      refreshTeamLabels();
      renderStudentList();
      renderSelectedList();
      return;
    }

    const maxTotal = sysConfig.groupSize + (sysConfig.groupSize * sysConfig.waitlistCount);
    if (selectedTeam.length >= maxTotal) {
      return showToast(`å·²é”é¸å–ä¸Šé™ (${maxTotal}äºº)ï¼`, "error");
    }

    selectedTeam.push({...stu});
    refreshTeamLabels();
    renderStudentList();
    renderSelectedList();
  }

  function refreshTeamLabels() {
    const mainClass = selectedTeam.length > 0 ? selectedTeam[0].A : '';
    selectedTeam.forEach((s, idx) => {
      if (idx < sysConfig.groupSize) {
        s.targetLabel = `${mainClass}-æ­£å–`;
        s.tagClass = 'main';
      } else {
        const waitlistNum = Math.floor((idx - sysConfig.groupSize) / sysConfig.groupSize) + 1;
        s.targetLabel = `${mainClass}-å‚™å–${waitlistNum}`;
        s.tagClass = 'wait';
      }
    });
  }

  function renderSelectedList() {
    const container = document.getElementById('selectedListContainer');
    
    // åŒæ­¥æ›´æ–°æ‰‹æ©Ÿç‰ˆåº•éƒ¨äººæ•¸
    document.getElementById('mobileSelectedCount').innerText = selectedTeam.length;

    if (selectedTeam.length === 0) {
      container.innerHTML = `<div style="text-align:center; color:var(--text-muted); margin-top:40px; font-weight:bold;">å°šç„¡é¸å–å­¸ç”Ÿ<br>è«‹å¾å·¦å´é»æ“ŠåŠ å…¥</div>`;
      return;
    }

    container.innerHTML = selectedTeam.map(s => `
      <div class="selected-item">
        <div style="display:flex; flex-direction:column; gap:4px;">
          <span style="font-size:14px; color:var(--text-muted); font-weight:bold;">${s.A}ç­ - ${s.B}è™Ÿ</span>
          <strong style="font-size:18px; color:var(--text-main);">${s.C}</strong>
        </div>
        <div style="display:flex; align-items:center; gap:12px;">
          <span class="tag ${s.tagClass}">${s.targetLabel}</span>
          <button class="remove-btn-small" onclick="toggleSelect(${s.rowIndex}, event)">âœ•</button>
        </div>
      </div>
    `).join('');
  }

  function clearSelected() {
    if(selectedTeam.length === 0) return;
    if(confirm("ç¢ºå®šè¦æ¸…ç©ºç›®å‰é¸å–çš„åå–®å—ï¼Ÿ")) {
      selectedTeam = [];
      renderStudentList();
      renderSelectedList();
    }
  }

  // ================== é€å‡ºçµ„éšŠå„²å­˜ ==================
  function submitGroup() {
    if (selectedTeam.length === 0) return showToast("è«‹å…ˆé¸å–å­¸ç”Ÿï¼", "error");
    
    if (selectedTeam.length < sysConfig.groupSize) {
      if(!confirm(`ç›®å‰åƒ…é¸å– ${selectedTeam.length} äººï¼Œæœªé”ä¸€çµ„äººæ•¸(${sysConfig.groupSize}äºº)ï¼Œç¢ºå®šè¦é€å‡ºå—ï¼Ÿ`)) return;
    }

    const payload = selectedTeam.map(s => ({
      rowIndex: s.rowIndex,
      E: 1, 
      F: s.targetLabel 
    }));

    showLoader(true);
    fetch(GAS_API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify({ action: 'saveGroupSignup', payload: payload })
    })
    .then(res => res.json())
    .then(data => {
      showLoader(false);
      if(data.error) throw new Error(data.error);
      
      showToast("ğŸ‰ å ±åå„²å­˜æˆåŠŸï¼");
      selectedTeam = []; 
      renderSelectedList();
      if(document.getElementById('classSelect').value) queryStudents(); 
    })
    .catch(err => {
      showLoader(false); showToast("å„²å­˜å¤±æ•—: " + err.message, "error");
    });
  }

  // ================== æª¢è¦–å·²å ±åæ¸…å–® (é®®è±”è¡¨æ ¼) ==================
  function fetchSignedList() {
    showLoader(true);
    fetch(`${GAS_API_URL}?action=getSignedList`)
      .then(res => res.json())
      .then(data => {
        showLoader(false);
        if(data.error) throw new Error(data.error);
        if(!data.rows || data.rows.length === 0) return showToast("ç›®å‰ç„¡äººå ±å", "info");

        const thead = `<tr>${data.headers.map(h => `<th>${h}</th>`).join('')}</tr>`;
        const tbody = data.rows.map(r => `<tr>${r.map(c => `<td>${c}</td>`).join('')}</tr>`).join('');
        
        document.getElementById('listTitle').textContent = "å…¨æ ¡å·²å ±ååå–®";
        document.getElementById('studentListContainer').innerHTML = `
          <div style="overflow-x:auto; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05);">
            <table class="vibrant-table">
              <thead>${thead}</thead>
              <tbody>${tbody}</tbody>
            </table>
          </div>
        `;
      })
      .catch(err => {
        showLoader(false); showToast("å–å¾—åå–®å¤±æ•—: " + err.message, "error");
      });
  }

  // ================== ç®¡ç†å“¡é€²éšè¨­å®š ==================
  function showAdminModal() {
    document.getElementById('adminPwd').value = '';
    document.getElementById('adminModal').style.display = 'flex';
  }

  function verifyAdmin() {
    const pwd = document.getElementById('adminPwd').value;
    if(pwd !== '000000') {
      showToast("å¯†ç¢¼éŒ¯èª¤", "error");
      return;
    }
    document.getElementById('adminModal').style.display = 'none';
    
    if(confirm("ç®¡ç†å“¡æ‚¨å¥½ï¼\næ˜¯å¦è¦æ¸…é™¤ã€Œæ‰€æœ‰å­¸ç”Ÿã€çš„å ±åç´€éŒ„(æ¢å¾©é è¨­å€¼)ï¼Ÿ\nâš ï¸ è­¦å‘Šï¼šæ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼")) {
      showLoader(true);
      fetch(GAS_API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify({ action: 'resetDefaults' })
      })
      .then(res => res.json())
      .then(data => {
        showLoader(false);
        if(data.error) throw new Error(data.error);
        showToast("å·²æ¢å¾©é è¨­å€¼ï¼æ‰€æœ‰åå–®å·²æ¸…ç©ºã€‚");
        currentClassStudents = [];
        document.getElementById('listTitle').textContent = "ç­ç´šå­¸ç”Ÿåˆ—è¡¨";
        document.getElementById('studentListContainer').innerHTML = `<div style="text-align:center; padding: 40px; color:#64748b; font-weight:bold;">è«‹é‡æ–°æŸ¥è©¢ç­ç´š</div>`;
      })
      .catch(err => {
        showLoader(false); showToast("é‡è¨­å¤±æ•—: " + err.message, "error");
      });
    }
  }
</script>
</body>
</html>