<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>çµ„éšŠå ±åç³»çµ±</title>
<style>
  :root {
    --primary: #2563eb;       
    --primary-light: #dbeafe; 
    --success: #059669;       
    --danger: #e11d48;        
    --warning: #d97706;       
    --info: #0ea5e9;          
    --bg-page: #f1f5f9;       
    --card-bg: #ffffff;
    --text-main: #0f172a;
    --text-muted: #64748b;
    --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
    --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
    --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
  }

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  
  html, body { height: 100%; margin: 0; }
  body {
    background: var(--bg-page); color: var(--text-main);
    font-family: system-ui, -apple-system, "Noto Sans TC", sans-serif;
    padding-bottom: 80px; 
  }
  
  .wrap { max-width: 1200px; margin: 20px auto; padding: 0 16px; }

  .header-title {
    font-size: 32px; font-weight: 900; text-align: center; margin-bottom: 20px;
    background: linear-gradient(135deg, #1e3a8a, #3b82f6); color: #fff;
    padding: 20px; border-radius: 16px; box-shadow: var(--shadow-md);
    letter-spacing: 2px;
  }

  .toast {
    position: fixed; left: 50%; top: 20px; transform: translateX(-50%);
    color: #fff; padding: 14px 28px; border-radius: 999px; box-shadow: var(--shadow-lg);
    z-index: 1700; display: none; font-weight: 800; font-size: 16px; white-space: nowrap;
  }
  .toast.show { display: block; animation: popDown 0.3s ease forwards; }
  @keyframes popDown { from { top: -20px; opacity: 0; } to { top: 20px; opacity: 1; } }
  .toast.success { background: var(--success); }
  .toast.error { background: var(--danger); }
  .toast.info { background: var(--info); }

  #loader {
    position: fixed; inset: 0; background: rgba(255,255,255,0.85); z-index: 1600;
    display: none; justify-content: center; align-items: center; flex-direction: column;
  }
  .spinner {
    width: 50px; height: 50px; border: 5px solid var(--primary-light);
    border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  .layout { display: flex; gap: 24px; flex-wrap: wrap; }
  .col-left { flex: 3; min-width: 320px; }
  .col-right { flex: 2; min-width: 320px; }

  .card {
    background: var(--card-bg); border-radius: 16px;
    padding: 20px; box-shadow: var(--shadow-md); margin-bottom: 20px;
  }

  .controls { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; margin-bottom: 20px; }
  select { 
    padding: 12px 16px; border-radius: 12px; border: 2px solid #cbd5e1; 
    font-size: 16px; min-width: 160px; font-weight: bold; outline: none; background: white;
  }
  select:focus { border-color: var(--primary); }
  
  .btn { 
    padding: 12px 20px; border: none; border-radius: 999px; color: #fff; 
    font-size: 16px; cursor: pointer; font-weight: 800; transition: all 0.2s;
    display: inline-flex; align-items: center; justify-content: center;
  }
  .btn:active { transform: scale(0.95); }
  .btn:disabled { opacity: 0.5; cursor: not-allowed; }
  .btn.blue { background: var(--primary); }
  .btn.green { background: var(--success); }
  .btn.red { background: var(--danger); }
  .btn.yellow { background: var(--warning); color: #fff; }
  .btn.pink { background: #db2777; }
  .btn.outline { background: transparent; border: 2px solid var(--danger); color: var(--danger); }
  .btn.outline-gray { background: transparent; border: 2px solid #94a3b8; color: #475569; }

  /* ===== APP é¢¨æ ¼çš„å­¸ç”Ÿåå–® ===== */
  .stu-list { display: flex; flex-direction: column; gap: 12px; margin-top: 10px; }
  
  .stu-card {
    display: flex; align-items: center; justify-content: space-between;
    padding: 16px; background: var(--card-bg); border-radius: 16px;
    box-shadow: var(--shadow-sm); border: 2px solid #e2e8f0;
    cursor: pointer; transition: 0.2s;
  }
  .stu-card:active { background: #f8fafc; transform: scale(0.99); }
  .stu-card.selected { border-color: var(--primary); background: var(--primary-light); }
  .stu-card.to-cancel { border-color: var(--danger); background: #fff1f2; opacity: 0.9; }
  
  .stu-info { display: flex; flex-direction: column; gap: 4px; }
  .stu-meta { font-size: 14px; color: var(--text-muted); font-weight: bold; }
  .stu-name { font-size: 20px; font-weight: 900; color: var(--text-main); }
  
  .stu-status-area { display: flex; align-items: center; gap: 12px; }
  .status-text { font-size: 15px; font-weight: 800; }
  
  .action-btn {
    padding: 8px 16px; border-radius: 999px; border: none; color: white;
    font-size: 14px; font-weight: bold; cursor: pointer;
  }
  .action-btn.add { background: var(--primary); }
  .action-btn.remove { background: var(--danger); }
  .action-btn.restore { background: var(--success); }

  /* å¾…æäº¤æ¸…å–® (å³å´) - æ¿ƒç¸®è¡Œé«˜å„ªåŒ– */
  .group-info { 
    background: #e0e7ff; color: #3730a3; padding: 10px 12px; border-radius: 12px; 
    margin-bottom: 12px; font-weight: 900; font-size: 15px; border: 1px dashed #818cf8;
  }
  .selected-list { min-height: 150px; display: flex; flex-direction: column; gap: 8px; }
  
  .selected-item {
    background: var(--card-bg); border-left: 6px solid var(--primary);
    border-radius: 10px; padding: 8px 12px; 
    display: flex; justify-content: space-between; align-items: center;
    box-shadow: var(--shadow-sm); border: 1px solid #e2e8f0; border-left-width: 6px;
  }
  
  .tag { border-radius: 6px; font-size: 13px; font-weight: 900; padding: 4px 8px; color: white; letter-spacing: 0.5px;}
  .tag.main { background: var(--success); }
  .tag.wait { background: var(--warning); }
  
  .remove-btn-small { 
    background: #f1f5f9; color: var(--text-muted); border: 1px solid #cbd5e1; border-radius: 6px; 
    padding: 4px 10px; cursor: pointer; font-size: 13px; font-weight: 900; 
  }
  .remove-btn-small:hover { background: #fee2e2; color: var(--danger); border-color: var(--danger); }

  /* å·²å ±ååå–®è¡¨æ ¼å°ˆç”¨ (é®®è±”æ¨£å¼) */
  .vibrant-table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 500px; }
  .vibrant-table th { background: var(--primary); color: white; padding: 16px; text-align: left; font-size: 16px;}
  .vibrant-table td { padding: 16px; background: white; border-bottom: 1px solid #e2e8f0; font-size: 16px; font-weight: bold; vertical-align: middle;}
  .vibrant-table tr:hover td { background: #f8fafc; }
  .vibrant-table th:first-child { border-top-left-radius: 12px; }
  .vibrant-table th:last-child { border-top-right-radius: 12px; }

  /* æ‰‹æ©Ÿç‰ˆç½®åº•æ“ä½œåˆ— */
  .mobile-bottom-bar {
    display: none; position: fixed; bottom: 0; left: 0; width: 100%;
    background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
    box-shadow: 0 -4px 15px rgba(0,0,0,0.1); padding: 12px 20px; 
    align-items: center; justify-content: space-between; z-index: 900;
    border-top: 1px solid #e2e8f0;
  }
  
  @media (max-width: 768px) {
    .col-main { order: 2; } 
    .col-side { order: 1; } 
    .mobile-bottom-bar { display: flex; } 
    .desktop-submit-area { display: none; } 
    body { padding-bottom: 90px; }
    
    .header-title { font-size: 24px; padding: 15px; }
    .stu-card { padding: 12px; }
    .stu-name { font-size: 18px; }
    .controls { flex-direction: column; align-items: stretch; }
  }

  /* Modals å…±ç”¨æ¨£å¼ */
  .modal-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);
    display: none; justify-content: center; align-items: center; z-index: 1200; overflow-y: auto; padding: 20px;
  }
  .modal { background: #fff; padding: 30px; border-radius: 20px; width: 100%; max-width: 400px; text-align: center; box-shadow: var(--shadow-lg); position: relative;}
  .modal-large { max-width: 600px; }
  
  .modal input { 
    width: 100%; padding: 12px; margin: 10px 0 20px; border: 2px solid #cbd5e1; 
    border-radius: 10px; font-size: 16px; font-weight: bold; text-align: center;
  }
  .modal input:focus { border-color: var(--primary); outline: none; }

  /* é€²éšè¨­å®šæŒ‰éˆ•ç¶²æ ¼ (ç¾åŒ–å‡ç´šç‰ˆ) */
  .adv-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 14px; margin-top: 20px; }
  @media (max-width: 480px) { .adv-grid { grid-template-columns: 1fr; } }
  
  .btn-adv { 
    padding: 16px 12px; border-radius: 16px; color: white; font-weight: bold; font-size: 16px; 
    border: none; cursor: pointer; display: flex; flex-direction: column; align-items: center; 
    justify-content: center; gap: 8px; transition: transform 0.2s, box-shadow 0.2s; 
    box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
  }
  .btn-adv:active { transform: scale(0.95); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
  .btn-adv-red { background: linear-gradient(135deg, #ef4444, #b91c1c); }
  .btn-adv-blue { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
  .btn-adv-green { background: linear-gradient(135deg, #10b981, #047857); }
  .btn-adv-teal { background: linear-gradient(135deg, #14b8a6, #0f766e); }
  .btn-adv-purple { background: linear-gradient(135deg, #8b5cf6, #5b21b6); }
  .btn-adv-orange { background: linear-gradient(135deg, #f59e0b, #b45309); }
  .btn-adv-gray { background: #f8fafc; color: #64748b; border: 2px dashed #cbd5e1; box-shadow: none; }
  .btn-adv-gray:hover { background: #e2e8f0; }

  /* åŸºæœ¬è¨­å®šè¡¨å–® */
  .settings-form { display: flex; flex-direction: column; gap: 10px; text-align: left; }
  .settings-form label { font-weight: bold; color: var(--text-main); font-size: 14px; margin-bottom: -5px;}
  .settings-form input { text-align: left; margin: 0; padding: 10px; }

  /* è·¨ç­çµ„éšŠé¸é …å€ */
  .cross-member-row { display: flex; gap: 10px; margin-bottom: 12px; text-align: left;}
  .cross-member-row select { width: 50%; min-width: unset; padding: 10px; border-radius: 8px; font-size: 15px;}

  /* ç¢ºèªè¦–çª—å°ˆç”¨å±¤ç´š (éœ€é«˜æ–¼å…¶ä»– Modal) */
  #confirmModal { z-index: 1800; }
</style>
</head>
<body>

<div id="loader">
  <div class="spinner"></div>
  <div style="margin-top: 15px; font-weight: bold; color: var(--primary); font-size: 18px;">ç³»çµ±è¼‰å…¥ä¸­...</div>
</div>
<div id="toast" class="toast"></div>

<div class="wrap layout">
  
  <!-- å·¦å´ï¼šæŒ‘é¸å­¸ç”Ÿ -->
  <div class="col-left col-main">
    <div class="header-title" id="pageTitle">çµ„éšŠå ±åç³»çµ±</div>

    <div class="card" id="noticeCard" style="background:#ecfdf5; border:2px solid #a7f3d0; display:none;">
      <h3 style="margin-top:0; color:var(--success);">ğŸ“Œ å ±åèªªæ˜</h3>
      <div id="noticeContent" style="font-weight: bold; line-height: 1.6;"></div>
    </div>

    <div class="card">
      <div class="controls">
        <select id="classSelect" onchange="queryStudents()">
          <option value="">-- è«‹é¸æ“‡ç­ç´š --</option>
        </select>
        <button class="btn yellow" onclick="fetchSignedList()">ğŸ“„ å·²å ±ååå–®</button>
        <button class="btn outline" onclick="showAdminModal()">âš™ï¸ é€²éšè¨­å®š</button>
      </div>
      
      <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:3px solid var(--primary); padding-bottom:10px; margin-top: 25px;">
        <h3 id="listTitle" style="margin:0; color:var(--primary); font-size: 22px;">ç­ç´šå­¸ç”Ÿåˆ—è¡¨</h3>
      </div>
      
      <div id="studentListContainer" class="stu-list">
        <div style="text-align:center; padding: 40px 20px; color: var(--text-muted); font-weight: bold; font-size: 18px; background: #f8fafc; border-radius: 16px; border: 2px dashed #cbd5e1;">
          ğŸ‘† è«‹å…ˆç”±ä¸Šæ–¹é¸æ“‡ç­ç´šï¼Œç³»çµ±å°‡è‡ªå‹•è¼‰å…¥åå–®
        </div>
      </div>
    </div>
  </div>

  <!-- å³å´ï¼šå¾…æäº¤çµ„éšŠåå–® -->
  <div class="col-right col-side">
    <div class="card" style="border: 3px solid var(--primary); position: sticky; top: 20px;">
      <h3 style="margin-top:0; color:var(--primary); font-size: 22px; display: flex; align-items: center; gap: 8px;">
        ğŸ“ ç›®å‰çµ„éšŠç‹€æ…‹
      </h3>
      
      <div class="group-info" id="groupRuleInfo">
        è¨­å®šï¼šè¼‰å…¥ä¸­...
      </div>

      <div class="selected-list" id="selectedListContainer">
         <div style="text-align:center; color:var(--text-muted); margin-top:40px; font-weight: bold;">
           å°šæœªè¼‰å…¥éšŠä¼<br>è«‹å¾å·¦å´æŸ¥è©¢ç­ç´šæˆ–æ‰‹å‹•åŠ å…¥
         </div>
      </div>

      <!-- æ¡Œæ©Ÿç‰ˆæŒ‰éˆ•å€ -->
      <div class="desktop-submit-area" style="margin-top: 25px; display: flex; gap: 12px;">
        <button class="btn green" style="flex:2; font-size: 18px;" onclick="submitGroup()">ğŸš€ é€å‡ºå ±å</button>
        <button class="btn outline" style="flex:1;" onclick="clearSelected()">æ¸…ç©ºå³å´</button>
      </div>
    </div>
  </div>
</div>

<!-- æ‰‹æ©Ÿç‰ˆå°ˆå±¬ï¼šç½®åº•æ“ä½œåˆ— -->
<div class="mobile-bottom-bar">
  <div style="display: flex; flex-direction: column;">
    <span style="font-size: 14px; color: var(--text-muted); font-weight: bold;">ç›®å‰éšŠä¼åå–®</span>
    <span style="font-size: 20px; font-weight: 900; color: var(--primary);">
      <span id="mobileSelectedCount">0</span> äºº
    </span>
  </div>
  <div style="display: flex; gap: 10px;">
    <button class="btn outline" style="padding: 10px 15px;" onclick="clearSelected()">æ¸…ç©º</button>
    <button class="btn green" style="padding: 12px 24px; font-size: 18px;" onclick="submitGroup()">é€å‡º</button>
  </div>
</div>

<!-- ================== Modals è¦–çª—å€ ================== -->

<!-- 1. å…±ç”¨ç¢ºèªè¦–çª— (å–ä»£åŸç”Ÿçš„ confirm) -->
<div class="modal-overlay" id="confirmModal">
  <div class="modal">
    <h3 id="confirmTitle" style="margin-top:0; color: var(--primary); font-size: 24px;">ç¢ºèª</h3>
    <p id="confirmMessage" style="font-size: 17px; font-weight: bold; color: var(--text-main); white-space: pre-wrap; line-height: 1.5; margin: 20px 0;"></p>
    <div style="display: flex; gap: 12px; margin-top: 25px;">
      <button class="btn outline-gray" style="flex:1; font-size: 18px;" onclick="closeConfirmModal()">å–æ¶ˆ</button>
      <button class="btn" id="confirmBtn" style="flex:1; font-size: 18px;" onclick="executeConfirm()">ç¢ºå®š</button>
    </div>
  </div>
</div>

<!-- 2. é¸æ“‡èº«åˆ† Modal -->
<div class="modal-overlay" id="roleSelectionModal">
  <div class="modal">
    <h3 style="margin-top:0; color: var(--primary);">é¸æ“‡åŠ å…¥èº«åˆ†</h3>
    <p style="font-size: 18px; font-weight: bold; color: var(--text-main);" id="roleModalStuName"></p>
    <div style="display: flex; flex-direction: column; gap: 12px; margin-top: 20px;">
      <button class="btn green" id="btnRoleMain" onclick="confirmAddRole('Main')" style="padding: 15px; font-size:18px;">æ­£å– (0/0)</button>
      <button class="btn yellow" id="btnRoleWait" onclick="confirmAddRole('Wait')" style="padding: 15px; font-size:18px;">å‚™å– (0/0)</button>
      <button class="btn outline-gray" onclick="closeAllModals()" style="margin-top: 10px;">å–æ¶ˆ</button>
    </div>
  </div>
</div>

<!-- 3. ç®¡ç†å“¡å¯†ç¢¼è¦–çª— -->
<div class="modal-overlay" id="adminPwdModal">
  <div class="modal">
    <h3 style="margin-top:0; color: var(--danger);">ç®¡ç†å“¡é©—è­‰</h3>
    <input type="password" id="adminPwd" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" maxlength="6" inputmode="numeric">
    <div style="display: flex; gap: 10px;">
      <button class="btn outline-gray" style="flex:1;" onclick="closeAllModals()">å–æ¶ˆ</button>
      <button class="btn red" style="flex:1;" onclick="verifyAdmin()">ç¢ºå®š</button>
    </div>
  </div>
</div>

<!-- 4. é€²éšè¨­å®šä¸»é¸å–® (ç¾åŒ–ç‰ˆ 10 å€‹æŒ‰éˆ•) -->
<div class="modal-overlay" id="advancedMenuModal">
  <div class="modal modal-large">
    <h3 style="margin-top:0; color: var(--text-main);">âš™ï¸ é€²éšè¨­å®š</h3>
    <div class="adv-grid">
      <button class="btn-adv btn-adv-red" onclick="triggerResetDefaults()"><span style="font-size:28px;">ğŸ—‘ï¸</span>1. å›å¾©é è¨­å€¼</button>
      <button class="btn-adv btn-adv-blue" onclick="openBasicSettings()"><span style="font-size:28px;">ğŸ“</span>2. åŸºæœ¬è¨­å®š</button>
      <button class="btn-adv btn-adv-green" onclick="window.open('https://script.google.com/a/macros/fjm.kh.edu.tw/s/AKfycbzg_pBsmpXIe5PX3B7cdF1IImXLVzUvEm8yuU3JLYZzaTYQ_5Ctn-0ooP5XfSLb_FVB/exec','_blank')"><span style="font-size:28px;">ğŸ«</span>3. å­¸å‹™è™•å…¬å‡å–®</button>
      <button class="btn-adv btn-adv-teal" onclick="window.open('#','_blank')"><span style="font-size:28px;">ğŸ“‹</span>4. ç­ç´šå…¬å‡å–®</button>
      <button class="btn-adv btn-adv-purple" onclick="window.open('https://drive.google.com/drive/u/0/folders/1LahyXKfZDnOVvJ7Yw-abNJN04hKfLO6a','_blank')"><span style="font-size:28px;">ğŸ“</span>5. é›²ç«¯è³‡æ–™å¤¾</button>
      <button class="btn-adv btn-adv-orange" onclick="openCrossClassModal()"><span style="font-size:28px;">ğŸ¤</span>6. è·¨ç­çµ„éšŠ</button>
      <button class="btn-adv btn-adv-gray"><span style="font-size:24px;">ğŸ”’</span>7. é å‚™åŠŸèƒ½</button>
      <button class="btn-adv btn-adv-gray"><span style="font-size:24px;">ğŸ”’</span>8. é å‚™åŠŸèƒ½</button>
      <button class="btn-adv btn-adv-gray"><span style="font-size:24px;">ğŸ”’</span>9. é å‚™åŠŸèƒ½</button>
      <button class="btn-adv btn-adv-gray"><span style="font-size:24px;">ğŸ”’</span>10. é å‚™åŠŸèƒ½</button>
    </div>
    <button class="btn outline-gray" style="margin-top:25px; width: 100%; padding: 12px; font-size: 18px;" onclick="closeAllModals()">é—œé–‰é¸å–®</button>
  </div>
</div>

<!-- 5. åŸºæœ¬è³‡æ–™è¨­å®š Modal -->
<div class="modal-overlay" id="basicSettingsModal">
  <div class="modal modal-large">
    <h3 style="margin-top:0; color: var(--primary);">ğŸ“ åŸºæœ¬è³‡æ–™è¨­å®š</h3>
    <div class="settings-form" id="settingsFormContainer">
      <!-- JS å‹•æ…‹ç”Ÿæˆè¡¨å–® -->
    </div>
    <div style="display: flex; gap: 10px; margin-top: 20px;">
      <button class="btn outline-gray" style="flex:1;" onclick="document.getElementById('basicSettingsModal').style.display='none'; document.getElementById('advancedMenuModal').style.display='flex';">è¿”å›</button>
      <button class="btn green" style="flex:1;" onclick="saveBasicSettings()">å„²å­˜è¨­å®š</button>
    </div>
  </div>
</div>

<!-- 6. è·¨ç­çµ„éšŠ Modal -->
<div class="modal-overlay" id="crossClassModal">
  <div class="modal modal-large">
    <h3 style="margin-top:0; color: var(--primary);">ğŸŒ è·¨ç­çµ„éšŠ</h3>
    <p style="color: var(--text-muted); font-weight: bold;">è«‹é¸æ“‡ 3 ä½å­¸ç”Ÿçµ„æˆè·¨ç­éšŠä¼ï¼š</p>
    <div id="crossClassMembers" style="margin-top: 20px;">
      <!-- éšŠå“¡ 1 -->
      <div class="cross-member-row">
        <select id="ccClass1" onchange="fetchCrossStudents(1)"></select>
        <select id="ccStudent1"><option value="">-- å…ˆé¸ç­ç´š --</option></select>
      </div>
      <!-- éšŠå“¡ 2 -->
      <div class="cross-member-row">
        <select id="ccClass2" onchange="fetchCrossStudents(2)"></select>
        <select id="ccStudent2"><option value="">-- å…ˆé¸ç­ç´š --</option></select>
      </div>
      <!-- éšŠå“¡ 3 -->
      <div class="cross-member-row">
        <select id="ccClass3" onchange="fetchCrossStudents(3)"></select>
        <select id="ccStudent3"><option value="">-- å…ˆé¸ç­ç´š --</option></select>
      </div>
    </div>
    <div style="display: flex; gap: 10px; margin-top: 25px;">
      <button class="btn outline-gray" style="flex:1;" onclick="document.getElementById('crossClassModal').style.display='none'; document.getElementById('advancedMenuModal').style.display='flex';">è¿”å›</button>
      <button class="btn green" style="flex:1;" onclick="triggerSubmitCrossClassTeam()">é€å‡ºè·¨ç­éšŠä¼</button>
    </div>
  </div>
</div>


<script>
  // ==========================================
  // âš ï¸ éƒ¨ç½²è¨­å®šå€ï¼šè«‹æ›¿æ›ç‚ºæ‚¨çš„ GAS ç¶²é æ‡‰ç”¨ç¨‹å¼ç¶²å€
  // ==========================================
  const GAS_API_URL = "https://script.google.com/macros/s/AKfycbww9F0m7-6g3d9toQ8KVBheIHVAjvstSWAcf2lYUs5vjjQFHay2i_01VjnJ2-snLptk/exec"; 
  
  let sysConfig = { groupSize: 3, mainGroups: 1, waitlistCount: 1 };
  let currentClassStudents = []; 
  let sysClasses = []; 
  
  let sysState = { dbRegistered: new Map(), userRemoved: new Set() };
  let selectedTeam = []; 
  let pendingAddRowIndex = null;
  
  // è‡ªè¨‚ Confirm Modal è®Šæ•¸
  let confirmCallback = null;

  // ================== UI è¼”åŠ©å‡½å¼ ==================
  function showLoader(show) { document.getElementById('loader').style.display = show ? 'flex' : 'none'; }
  function showToast(msg, type='success') {
    const el = document.getElementById('toast');
    el.textContent = msg; el.className = 'toast ' + type + ' show';
    setTimeout(() => el.classList.remove('show'), 3000);
  }
  function closeAllModals() {
    document.querySelectorAll('.modal-overlay').forEach(el => el.style.display = 'none');
  }

  // ================== è‡ªè¨‚ Confirm è¦–çª—é‚è¼¯ ==================
  function showConfirm(title, message, callback, btnText = 'ç¢ºå®š', btnColor = 'green') {
    document.getElementById('confirmTitle').textContent = title;
    document.getElementById('confirmTitle').style.color = (btnColor === 'red') ? 'var(--danger)' : (btnColor === 'yellow' ? 'var(--warning)' : 'var(--primary)');
    document.getElementById('confirmMessage').textContent = message;
    
    const btn = document.getElementById('confirmBtn');
    btn.textContent = btnText;
    btn.className = `btn ${btnColor}`;
    
    confirmCallback = callback;
    document.getElementById('confirmModal').style.display = 'flex';
  }

  function closeConfirmModal() {
    document.getElementById('confirmModal').style.display = 'none';
    confirmCallback = null;
  }

  function executeConfirm() {
    if (confirmCallback) confirmCallback();
    closeConfirmModal();
  }

  // ================== åˆå§‹åŒ–è¼‰å…¥ ==================
  window.onload = () => {
    showLoader(true);
    fetch(`${GAS_API_URL}?action=getInitData`)
      .then(res => res.json())
      .then(data => {
        if(data.error) throw new Error(data.error);
        
        document.getElementById('pageTitle').textContent = data.title;
        document.title = data.title;
        
        sysConfig.groupSize = data.groupSize || 3;
        sysConfig.mainGroups = data.mainGroups || 1;
        sysConfig.waitlistCount = data.waitlistCount || 1;
        sysClasses = data.classes || [];
        updateGroupRuleText();

        if(data.notices && data.notices.length > 0) {
          document.getElementById('noticeCard').style.display = 'block';
          document.getElementById('noticeContent').innerHTML = data.notices.map(n => `<p style="margin: 6px 0;">${n}</p>`).join('');
        }

        const select = document.getElementById('classSelect');
        sysClasses.forEach(c => {
          let opt = document.createElement('option');
          opt.value = c; opt.text = c + " ç­";
          select.appendChild(opt);
        });
        
        showLoader(false);
      })
      .catch(err => {
        showLoader(false);
        showToast("åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹ç¢ºèª GAS ç¶²å€: " + err.message, "error");
      });
  };

  function updateGroupRuleText() {
    document.getElementById('groupRuleInfo').textContent = 
      `ğŸ“Œ è¨­å®šï¼š1çµ„${sysConfig.groupSize}äººï¼Œæ­£å–${sysConfig.mainGroups}çµ„ã€å‚™å–${sysConfig.waitlistCount}çµ„`;
  }

  // ================== æŸ¥è©¢ç­ç´šå­¸ç”Ÿ ==================
  function queryStudents() {
    const cls = document.getElementById('classSelect').value;
    
    sysState.dbRegistered.clear();
    sysState.userRemoved.clear();
    selectedTeam = [];
    renderSelectedList();
    
    if(!cls) {
        document.getElementById('studentListContainer').innerHTML = `<div style="text-align:center; padding: 40px; color:#64748b; font-weight:bold;">ğŸ‘† è«‹å…ˆç”±ä¸Šæ–¹é¸æ“‡ç­ç´šï¼Œç³»çµ±å°‡è‡ªå‹•è¼‰å…¥åå–®</div>`;
        document.getElementById('listTitle').textContent = `ç­ç´šå­¸ç”Ÿåˆ—è¡¨`;
        return; 
    }

    showLoader(true);
    fetch(`${GAS_API_URL}?action=queryByClass&className=${encodeURIComponent(cls)}`)
      .then(res => res.json())
      .then(data => {
        showLoader(false);
        if(data.error) throw new Error(data.error);
        
        currentClassStudents = data.rows;
        document.getElementById('listTitle').textContent = `${cls} ç­ç´šå­¸ç”Ÿåˆ—è¡¨`;

        currentClassStudents.forEach(stu => {
            if (stu.E == 1 || stu.E == '1') {
                sysState.dbRegistered.set(stu.rowIndex, stu);
                if (!sysState.userRemoved.has(stu.rowIndex) && !selectedTeam.some(s => s.rowIndex === stu.rowIndex)) {
                    stu.targetLabel = stu.F || '';
                    stu.tagClass = stu.targetLabel.includes('æ­£å–') ? 'main' : (stu.targetLabel.includes('å‚™å–') ? 'wait' : 'primary');
                    selectedTeam.push({...stu});
                }
            }
        });

        renderStudentList();
        renderSelectedList();
      })
      .catch(err => {
        showLoader(false); showToast("æŸ¥è©¢å¤±æ•—: " + err.message, "error");
      });
  }

  function renderStudentList() {
    const container = document.getElementById('studentListContainer');
    container.innerHTML = '';
    
    if(currentClassStudents.length === 0) {
      container.innerHTML = `<div style="text-align:center; padding: 40px; color:#64748b; font-weight:bold;">æ­¤ç­ç´šæŸ¥ç„¡å­¸ç”Ÿè³‡æ–™</div>`;
      return;
    }

    currentClassStudents.forEach(stu => {
      const isSelected = selectedTeam.some(s => s.rowIndex === stu.rowIndex);
      const isRegisteredInDb = sysState.dbRegistered.has(stu.rowIndex);

      let cardClass = 'stu-card';
      let statusHtml = '';
      let btnHtml = '';

      if (isSelected) {
          cardClass += ' selected';
          statusHtml = '<span class="status-text" style="color:var(--primary);">ğŸ”µ å·²é¸å–</span>';
          btnHtml = `<button class="action-btn remove" onclick="handleRemove(${stu.rowIndex}, event)">ç§»é™¤</button>`;
      } else if (isRegisteredInDb) {
          cardClass += ' to-cancel';
          statusHtml = '<span class="status-text" style="color:var(--danger);">âŒ å¾…å–æ¶ˆ</span>';
          btnHtml = `<button class="action-btn restore" onclick="handleRestore(${stu.rowIndex}, event)">åŠ å›</button>`;
      } else {
          statusHtml = '<span class="status-text" style="color:var(--text-muted);">âšª æœªå ±å</span>';
          btnHtml = `<button class="action-btn add" onclick="openRoleModal(${stu.rowIndex}, event)">åŠ å…¥ +</button>`;
      }

      const div = document.createElement('div');
      div.className = cardClass;
      
      div.onclick = (e) => {
        if (isSelected) handleRemove(stu.rowIndex, e);
        else if (isRegisteredInDb) handleRestore(stu.rowIndex, e);
        else openRoleModal(stu.rowIndex, e);
      };
      
      div.innerHTML = `
        <div class="stu-info">
          <div class="stu-meta">åº§è™Ÿï¼š${stu.B}</div>
          <div class="stu-name">${stu.C}</div>
        </div>
        <div class="stu-status-area">
          ${statusHtml}
          ${btnHtml}
        </div>
      `;
      container.appendChild(div);
    });
  }

  // ================== åŠ å…¥èˆ‡ç§»é™¤é‚è¼¯ ==================
  
  function handleRemove(rowIndex, event) {
      if(event) event.stopPropagation();
      const existingIdx = selectedTeam.findIndex(s => s.rowIndex === rowIndex);
      if (existingIdx > -1) {
          selectedTeam.splice(existingIdx, 1);
          if (sysState.dbRegistered.has(rowIndex)) sysState.userRemoved.add(rowIndex);
      }
      renderStudentList();
      renderSelectedList();
  }

  function handleRestore(rowIndex, event) {
      if(event) event.stopPropagation();
      const dbStu = sysState.dbRegistered.get(rowIndex);
      if (dbStu) {
          sysState.userRemoved.delete(rowIndex);
          dbStu.targetLabel = dbStu.F || '';
          dbStu.tagClass = dbStu.targetLabel.includes('æ­£å–') ? 'main' : 'wait';
          selectedTeam.push({...dbStu});
      }
      renderStudentList();
      renderSelectedList();
  }

  function openRoleModal(rowIndex, event) {
      if(event) event.stopPropagation();
      
      pendingAddRowIndex = rowIndex;
      const stu = currentClassStudents.find(s => s.rowIndex === rowIndex);
      document.getElementById('roleModalStuName').textContent = `å°‡ã€Œ${stu.C}ã€åŠ å…¥ç‚ºï¼š`;

      const mainLimit = sysConfig.groupSize * sysConfig.mainGroups;
      const waitLimit = sysConfig.groupSize * sysConfig.waitlistCount;
      
      let currentMain = 0;
      let currentWait = 0;
      selectedTeam.forEach(s => {
          if(s.targetLabel && s.targetLabel.includes('æ­£å–')) currentMain++;
          else if(s.targetLabel && s.targetLabel.includes('å‚™å–')) currentWait++;
      });

      const btnMain = document.getElementById('btnRoleMain');
      const btnWait = document.getElementById('btnRoleWait');

      btnMain.textContent = `æ­£å– (${currentMain}/${mainLimit})`;
      btnMain.disabled = currentMain >= mainLimit; 
      
      btnWait.textContent = `å‚™å– (${currentWait}/${waitLimit})`;
      btnWait.disabled = currentWait >= waitLimit; 

      document.getElementById('roleSelectionModal').style.display = 'flex';
  }

  function confirmAddRole(roleType) {
      const stu = currentClassStudents.find(s => s.rowIndex === pendingAddRowIndex);
      const cls = document.getElementById('classSelect').value;
      
      if(roleType === 'Main') {
          stu.targetLabel = `${cls}-æ­£å–`;
          stu.tagClass = 'main';
      } else {
          stu.targetLabel = `${cls}-å‚™å–1`;
          stu.tagClass = 'wait';
      }

      selectedTeam.push({...stu});
      document.getElementById('roleSelectionModal').style.display = 'none';
      renderStudentList();
      renderSelectedList();
  }

  // æ›¿æ›åŸç”Ÿ confirm ç‚º Custom Modal
  function clearSelected() {
      if(selectedTeam.length === 0) return;
      showConfirm("æ¸…ç©ºç¢ºèª", "ç¢ºå®šè¦æ¸…ç©ºå³å´åå–®å—ï¼Ÿ\n(è‹¥åå–®å…§æœ‰å·²å ±åå­¸ç”Ÿï¼Œé€å‡ºå¾Œå°‡æœƒè¢«å–æ¶ˆå ±å)", () => {
          selectedTeam.forEach(s => {
              if (sysState.dbRegistered.has(s.rowIndex)) sysState.userRemoved.add(s.rowIndex);
          });
          selectedTeam = [];
          renderStudentList();
          renderSelectedList();
      }, "ç¢ºå®šæ¸…ç©º", "red");
  }

  function renderSelectedList() {
      const container = document.getElementById('selectedListContainer');
      document.getElementById('mobileSelectedCount').innerText = selectedTeam.length;

      if (selectedTeam.length === 0) {
          container.innerHTML = `<div style="text-align:center; color:var(--text-muted); margin-top:40px; font-weight:bold;">éšŠä¼ç›®å‰ç„¡äºº<br>è«‹å¾å·¦å´é»é¸åŠ å…¥</div>`;
          return;
      }

      selectedTeam.sort((a, b) => {
          const aIsMain = a.tagClass === 'main';
          const bIsMain = b.tagClass === 'main';
          if (aIsMain && !bIsMain) return -1;
          if (!aIsMain && bIsMain) return 1;
          return parseInt(a.B) - parseInt(b.B);
      });

      container.innerHTML = selectedTeam.map(s => {
        const borderCol = s.tagClass === 'main' ? 'var(--success)' : 'var(--warning)';
        return `
          <div class="selected-item" style="border-left-color: ${borderCol};">
            <div style="display:flex; flex-direction:column; gap:2px;">
              <span style="font-size:12px; color:var(--text-muted); font-weight:bold;">${s.A}ç­ - ${s.B}è™Ÿ</span>
              <strong style="font-size:16px; color:var(--text-main);">${s.C}</strong>
            </div>
            <div style="display:flex; align-items:center; gap:8px;">
              <span class="tag ${s.tagClass}">${s.targetLabel || 'æœªå®š'}</span>
              <button class="remove-btn-small" onclick="handleRemove(${s.rowIndex}, event)">âœ•</button>
            </div>
          </div>
        `;
      }).join('');
  }

  // ================== çµ±ä¸€é€å‡ºè®Šæ›´ ==================
  function submitGroup() {
      const payload = [];
      let hasChanges = false;

      sysState.dbRegistered.forEach((dbStu, rowIndex) => {
          if (!selectedTeam.some(s => s.rowIndex === rowIndex)) {
              payload.push({ rowIndex: rowIndex, E: 0, F: '' }); 
              hasChanges = true;
          }
      });

      selectedTeam.forEach(s => {
          payload.push({ rowIndex: s.rowIndex, E: 1, F: s.targetLabel });
          hasChanges = true;
      });

      if (!hasChanges && payload.length === 0) return showToast("æ²’æœ‰ä»»ä½•è®Šæ›´å¯ä»¥é€å‡ºï¼", "error");

      const totalExpected = sysConfig.groupSize * (sysConfig.mainGroups + sysConfig.waitlistCount);
      
      const doSubmit = () => {
          showLoader(true);
          fetch(GAS_API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            body: JSON.stringify({ action: 'saveGroupSignup', payload: payload })
          })
          .then(res => res.json())
          .then(data => {
            showLoader(false);
            if(data.error) throw new Error(data.error);
            showToast("ğŸ‰ å ±åèˆ‡è®Šæ›´å·²æˆåŠŸé€å‡ºï¼");
            sysState.dbRegistered.clear();
            sysState.userRemoved.clear();
            selectedTeam = []; 
            renderSelectedList();
            if(document.getElementById('classSelect').value) queryStudents(); 
          })
          .catch(err => {
            showLoader(false); showToast("å„²å­˜å¤±æ•—: " + err.message, "error");
          });
      };

      // æ›¿æ›åŸç”Ÿ confirm ç‚º Custom Modal
      if (selectedTeam.length > 0 && selectedTeam.length !== totalExpected) {
          showConfirm("äººæ•¸ä¸è¶³æç¤º", `ç›®å‰éšŠä¼å…± ${selectedTeam.length} äººï¼Œä¸ç¬¦åˆå®Œæ•´ç·¨åˆ¶ (${totalExpected} äºº)\nç¢ºå®šè¦ç›´æ¥é€å‡ºå—ï¼Ÿ`, doSubmit, "å¼·åˆ¶é€å‡º", "yellow");
      } else if (payload.length > 0) {
          showConfirm("å„²å­˜ç¢ºèª", "ç¢ºå®šè¦å„²å­˜ç›®å‰çš„çµ„éšŠç•°å‹•å—ï¼Ÿ", doSubmit, "ç¢ºå®šé€å‡º", "blue");
      }
  }

  // ================== æª¢è¦–å·²å ±åæ¸…å–® ==================
  function fetchSignedList() {
    showLoader(true);
    fetch(`${GAS_API_URL}?action=getSignedList`)
      .then(res => res.json())
      .then(data => {
        showLoader(false);
        if(data.error) throw new Error(data.error);
        if(!data.rows || data.rows.length === 0) return showToast("ç›®å‰ç„¡äººå ±å", "info");

        const groupColIdx = data.headers.findIndex(h => h === 'çµ„åˆ¥');
        const officialColIdx = data.headers.findIndex(h => h === 'æ­£å¼çµ„åˆ¥');

        const thead = `<tr>${data.headers.map(h => `<th>${h}</th>`).join('')}</tr>`;
        const tbody = data.rows.map(r => `<tr>${r.map((c, i) => {
            if ((i === groupColIdx || i === officialColIdx) && c) {
                let tagClass = c.includes('æ­£å–') ? 'main' : (c.includes('å‚™å–') ? 'wait' : 'primary');
                return `<td><span class="tag ${tagClass}" style="display:inline-block; padding: 6px 12px; font-size:14px;">${c}</span></td>`;
            }
            return `<td>${c}</td>`;
        }).join('')}</tr>`).join('');
        
        document.getElementById('listTitle').textContent = "å…¨æ ¡å·²å ±ååå–®";
        document.getElementById('studentListContainer').innerHTML = `
          <div style="overflow-x:auto; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05);">
            <table class="vibrant-table">
              <thead>${thead}</thead>
              <tbody>${tbody}</tbody>
            </table>
          </div>
        `;
      })
      .catch(err => {
        showLoader(false); showToast("å–å¾—åå–®å¤±æ•—: " + err.message, "error");
      });
  }

  // ================== ç®¡ç†å“¡é€²éšè¨­å®šèˆ‡é©—è­‰ ==================
  function showAdminModal() {
    document.getElementById('adminPwd').value = '';
    document.getElementById('adminPwdModal').style.display = 'flex';
  }

  function verifyAdmin() {
    const pwd = document.getElementById('adminPwd').value;
    if(pwd !== '000000') return showToast("å¯†ç¢¼éŒ¯èª¤", "error");
    
    document.getElementById('adminPwdModal').style.display = 'none';
    document.getElementById('advancedMenuModal').style.display = 'flex';
  }

  // æ›¿æ›åŸç”Ÿ confirm
  function triggerResetDefaults() {
    document.getElementById('advancedMenuModal').style.display = 'none'; // æš«æ™‚éš±è—è¨­å®šé¸å–®
    showConfirm("âš ï¸ æ¥µåº¦å±éšªæ“ä½œ", "é€™å°‡æ¸…é™¤ã€Œæ‰€æœ‰å­¸ç”Ÿã€çš„å ±åç´€éŒ„(æ¢å¾©é è¨­å€¼)ï¼\næ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼Œç¢ºå®šè¦åŸ·è¡Œå—ï¼Ÿ", () => {
        showLoader(true);
        fetch(GAS_API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify({ action: 'resetDefaults' })
        })
        .then(res => res.json())
        .then(data => {
          showLoader(false);
          if(data.error) throw new Error(data.error);
          showToast("å·²æ¢å¾©é è¨­å€¼ï¼æ‰€æœ‰åå–®å·²æ¸…ç©ºã€‚");
          currentClassStudents = [];
          sysState.dbRegistered.clear();
          sysState.userRemoved.clear();
          selectedTeam = [];
          renderSelectedList();
          document.getElementById('listTitle').textContent = "ç­ç´šå­¸ç”Ÿåˆ—è¡¨";
          document.getElementById('studentListContainer').innerHTML = `<div style="text-align:center; padding: 40px; color:#64748b; font-weight:bold;">è«‹é‡æ–°æŸ¥è©¢ç­ç´š</div>`;
        })
        .catch(err => {
          showLoader(false); showToast("é‡è¨­å¤±æ•—: " + err.message, "error");
        });
    }, "ç¢ºèªæ¸…é™¤å…¨éƒ¨", "red");
  }

  // ================== åŸºæœ¬è³‡æ–™è¨­å®š ==================
  function openBasicSettings() {
    document.getElementById('advancedMenuModal').style.display = 'none';
    showLoader(true);
    
    fetch(GAS_API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify({ action: 'getBasicSettings' })
    })
    .then(res => res.json())
    .then(data => {
      showLoader(false);
      if(data.error) throw new Error(data.error);
      
      const formContainer = document.getElementById('settingsFormContainer');
      formContainer.innerHTML = '';
      
      data.data.forEach((row, idx) => {
          if(!row[0]) return; 
          const div = document.createElement('div');
          div.innerHTML = `
              <label>${row[0]}</label>
              <input type="text" id="settingInput_${idx}" value="${row[1] || ''}" />
          `;
          formContainer.appendChild(div);
      });
      
      document.getElementById('basicSettingsModal').style.display = 'flex';
    })
    .catch(err => {
      showLoader(false); showToast("è®€å–è¨­å®šå¤±æ•—: " + err.message, "error");
      document.getElementById('advancedMenuModal').style.display = 'flex';
    });
  }

  function saveBasicSettings() {
    const payload = [];
    const inputs = document.querySelectorAll('#settingsFormContainer input');
    inputs.forEach((input, idx) => {
        payload.push([null, input.value.trim()]);
    });

    showLoader(true);
    fetch(GAS_API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify({ action: 'saveBasicSettings', payload: payload })
    })
    .then(res => res.json())
    .then(data => {
      showLoader(false);
      if(data.error) throw new Error(data.error);
      showToast("è¨­å®šå·²æˆåŠŸå„²å­˜ï¼Œå³å°‡é‡æ–°è¼‰å…¥é é¢ï¼");
      setTimeout(() => window.location.reload(), 1500);
    })
    .catch(err => {
      showLoader(false); showToast("å„²å­˜è¨­å®šå¤±æ•—: " + err.message, "error");
    });
  }

  // ================== è·¨ç­çµ„éšŠ (ä¿®å¾©å‚³é€æ•¸å€¼å‹æ…‹) ==================
  function openCrossClassModal() {
    document.getElementById('advancedMenuModal').style.display = 'none';
    
    [1, 2, 3].forEach(num => {
        const clsSel = document.getElementById(`ccClass${num}`);
        clsSel.innerHTML = '<option value="">-- é¸æ“‡ç­ç´š --</option>';
        sysClasses.forEach(c => {
            clsSel.innerHTML += `<option value="${c}">${c} ç­</option>`;
        });
        document.getElementById(`ccStudent${num}`).innerHTML = '<option value="">-- å…ˆé¸ç­ç´š --</option>';
    });
    
    document.getElementById('crossClassModal').style.display = 'flex';
  }

  function fetchCrossStudents(num) {
    const cls = document.getElementById(`ccClass${num}`).value;
    const stuSel = document.getElementById(`ccStudent${num}`);
    if(!cls) {
        stuSel.innerHTML = '<option value="">-- å…ˆé¸ç­ç´š --</option>';
        return;
    }
    
    stuSel.innerHTML = '<option value="">è¼‰å…¥ä¸­...</option>';
    fetch(`${GAS_API_URL}?action=queryByClass&className=${encodeURIComponent(cls)}`)
      .then(res => res.json())
      .then(data => {
          if(data.error) throw new Error(data.error);
          stuSel.innerHTML = '<option value="">-- é¸æ“‡å­¸ç”Ÿ --</option>';
          data.rows.forEach(stu => {
              const isReg = (stu.E == 1 || stu.E == '1');
              const mark = isReg ? ' (å·²å ±å)' : '';
              stuSel.innerHTML += `<option value="${stu.rowIndex}" ${isReg ? 'disabled' : ''}>${stu.B}è™Ÿ - ${stu.C}${mark}</option>`;
          });
      })
      .catch(err => {
          stuSel.innerHTML = '<option value="">è¼‰å…¥å¤±æ•—</option>';
          showToast("è¼‰å…¥å­¸ç”Ÿå¤±æ•—", "error");
      });
  }

  // æ›¿æ›åŸç”Ÿ confirm ä¸¦ä¿®å¾©å‹æ…‹ bug
  function triggerSubmitCrossClassTeam() {
    const stu1 = document.getElementById('ccStudent1').value;
    const stu2 = document.getElementById('ccStudent2').value;
    const stu3 = document.getElementById('ccStudent3').value;

    if(!stu1 || !stu2 || !stu3) return showToast("è«‹å®Œæ•´é¸æ“‡ 3 ä½å­¸ç”Ÿï¼", "error");
    if(new Set([stu1, stu2, stu3]).size !== 3) return showToast("ä¸èƒ½é¸æ“‡é‡è¤‡çš„å­¸ç”Ÿï¼", "error");

    document.getElementById('crossClassModal').style.display = 'none'; // å…ˆéš±è—è·¨ç­è¦–çª—
    
    showConfirm("è·¨ç­çµ„éšŠç¢ºèª", "ç¢ºå®šè¦å°‡é€™ 3 ä½å­¸ç”Ÿçµ„æˆè·¨ç­éšŠä¼å—ï¼Ÿ", () => {
        showLoader(true);
        // ã€é—œéµä¿®å¾©ã€‘ï¼šå°‡å­—ä¸² value è½‰æ›ç‚º Numberï¼Œé¿å…å¾Œç«¯ GAS getRange(å­—ä¸²) ç™¼ç”ŸéŒ¯èª¤ï¼
        const numPayload = [Number(stu1), Number(stu2), Number(stu3)];
        
        fetch(GAS_API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            body: JSON.stringify({ action: 'saveCrossClassTeam', payload: numPayload })
        })
        .then(res => res.json())
        .then(data => {
            showLoader(false);
            if(data.error) throw new Error(data.error);
            showToast(`ğŸ‰ è·¨ç­çµ„éšŠæˆåŠŸï¼çµ„åˆ¥ç‚ºï¼š${data.newTeam}`);
            closeAllModals();
            if(document.getElementById('classSelect').value) queryStudents(); 
        })
        .catch(err => {
            showLoader(false);
            showToast("è·¨ç­çµ„éšŠå¤±æ•—: " + err.message, "error");
        });
    }, "ç¢ºå®šçµ„éšŠ", "blue");
  }

</script>
</body>
</html>